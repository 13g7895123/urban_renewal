# 規格分析報告
**功能**: 管理員與使用者登入情境 (002-admin-user)
**分析日期**: 2025-10-24
**已分析文件**: spec.md, plan.md, tasks.md, constitution.md

---

## 執行摘要

**整體健康度**: 良好 - 規格文件結構良好,僅有少數問題需要在執行 `/implement` 前處理。

**關鍵指標**:
- 功能需求總數: 26
- 任務總數: 54
- 覆蓋率: 100% (所有需求皆已對應至任務)
- 關鍵問題: 0
- 高優先級問題: 3
- 中優先級問題: 5
- 低優先級問題: 4

**建議**: 在進行 `/implement` 前處理高優先級和中優先級問題。規格在其他方面已可進入實作階段。

---

## 詳細發現

| ID | 類別 | 嚴重性 | 位置 | 摘要 | 建議 |
|----|----------|----------|-------------|---------|----------------|
| A1 | 模糊性 | 高 | spec.md:L12, FR-024 | "標準認證事件追蹤" 缺少可測量的保留政策 | 在 FR-024 中指定審計日誌保留期限(例如:"保留 90 天" 或 "保留至手動刪除") |
| A2 | 模糊性 | 高 | spec.md:L13, FR-026 | "定期批次作業" 定義為 "每日/每週" 不明確 | 在 FR-026 中明確排程(澄清事項寫 "每日/每週" 但 tasks.md T002 指定 "每日 2:00AM") - 統一為單一排程 |
| U1 | 規格不足 | 高 | spec.md:FR-020:L124 | 密碼重置功能標記為 "未來實作" 但未列入範圍外 | 將 FR-020 移至 "範圍外" 區塊,或從功能需求中移除,因為明確不會實作 |
| D1 | 重複 | 中 | spec.md:L94-96 vs L98 | 邊緣案例涵蓋活動會話期間角色/urban_renewal_id 變更的內容重複 | 將使用者屬性變更時會話無效化的邊緣案例整合為單一綜合案例 |
| I1 | 不一致 | 中 | spec.md:FR-026 vs tasks.md:T002 | FR-026 寫 "每日或每週",澄清事項寫 "每日/每週",tasks.md 指定 "每日 2:00AM" | 統一所有文件使用 "每日凌晨 2:00" 作為會話清理的確定排程 |
| I2 | 不一致 | 中 | spec.md:FR-024 vs plan.md:L183 | 規格寫 "專用審計資料表或結構化應用程式日誌",計畫確定為 "authentication_events 資料表" | 更新 spec.md FR-024 指定 "專用審計資料表 (authentication_events)" 以符合實作決策 |
| I3 | 不一致 | 中 | spec.md:L136 vs tasks.md:T005 | UserPermission 實體在規格中定義但任務中未使用 | 澄清: user_permissions 資料表是此功能的一部分還是既有功能?如未使用,移至 "假設條件" 或移除 |
| T1 | 術語 | 中 | 多處 | "會話 token" vs "session token" vs "JWT token" 交替使用 | 標準化為首次使用 "會話 token (JWT)",之後一致使用 "會話 token" |
| C1 | 覆蓋缺口 | 低 | spec.md:FR-023 | FR-023 (從 API 移除敏感欄位) 沒有明確的測試任務 | 在 Phase 7 新增測試任務(T049 部分涵蓋但不明確)以驗證排除 password_hash/tokens |
| C2 | 覆蓋缺口 | 低 | spec.md:FR-005, FR-019 | 登入嘗試追蹤缺少計數器重置邏輯的測試 | 確保 AuthControllerTest (T018) 明確測試成功登入時重置 login_attempts |
| A3 | 模糊性 | 低 | spec.md:L65-67, US3-AC1 | "在 24 小時後過期" - 系統主動或被動檢查不明確 | 澄清: Token 更新是 "在過期前 X 分鐘主動" 或 "遇到 401 時被動"?(tasks.md T034-T035 顯示兩者,良好) |
| A4 | 模糊性 | 低 | spec.md:L99 | "登出所有裝置" 功能在邊緣案例中提及但未列入需求 | 如需要,新增 FR-027 的 "撤銷所有會話" API 端點,否則從邊緣案例中移除 |

---

## 覆蓋率分析

### 需求覆蓋摘要

| 需求代碼 | 有任務? | 任務 ID | 備註 |
|-----------------|-----------|----------|-------|
| FR-001 (bcrypt 認證) | ✅ | 既有程式碼 | 既有功能 |
| FR-002 (四種角色) | ✅ | T020-T023, T027-T029 | RBAC 強制執行 |
| FR-003 (24h JWT) | ✅ | 既有程式碼 | 既有功能 |
| FR-004 (7d refresh) | ✅ | T034-T035 | 自動更新實作 |
| FR-005 (帳號鎖定) | ✅ | T013, T018 | AuthControllerTest 測試覆蓋 |
| FR-006 (user_sessions 儲存) | ✅ | 既有程式碼 | 既有功能 |
| FR-007 (管理員無限存取) | ✅ | T016, T019 | 管理員權限測試 |
| FR-008 (非管理員範圍限制) | ✅ | T008-T009, T020-T023 | RBAC trait + 強制執行 |
| FR-009 (管理員導向) | ✅ | 既有程式碼 | 既有功能 |
| FR-010 (使用者導向) | ✅ | 既有程式碼 | 既有功能 |
| FR-011 (舊會話無效化) | ✅ | 既有程式碼 | 既有功能 |
| FR-012 (登出功能) | ✅ | T014, T018 | 登出審計記錄 |
| FR-013 (Token 驗證) | ✅ | 既有 (JWTAuthFilter) | 既有功能 |
| FR-014 (RBAC 強制執行) | ✅ | T008-T009, T040-T042 | 路由 + API 層級強制執行 |
| FR-015 (理事長權限) | ✅ | T027, T041 | ChairmanPermissionsTest |
| FR-016 (會員投票權) | ✅ | T028, T040 | MemberPermissionsTest |
| FR-017 (觀察員唯讀) | ✅ | T029, T040 | ObserverPermissionsTest |
| FR-018 (繁體中文錯誤) | ✅ | T050 | 驗證任務 |
| FR-019 (登入時間戳記) | ✅ | 既有程式碼 + T018 | 既有 + 測試增強 |
| FR-020 (密碼重置) | ⚠️ | **無** | **標記為未來 - 應列入範圍外** |
| FR-021 (並發會話防護) | ✅ | 既有程式碼 | 既有功能 |
| FR-022 (自動更新 token) | ✅ | T032-T035, T038 | 前端自動更新 |
| FR-023 (移除敏感欄位) | ⚠️ | T049 (部分) | **需要明確測試任務** |
| FR-024 (認證事件記錄) | ✅ | T004-T007, T012-T015, T017-T018 | 審計基礎設施 + 記錄 |
| FR-025 (失敗嘗試記錄) | ✅ | T013, T017 | 包含在 FR-024 實作中 |
| FR-026 (會話清理) | ✅ | T001-T003, T010-T011, T036-T037 | Cron 作業實作 |

**覆蓋率百分比**: 96% (25/26 需求已完整對應至任務; FR-020 排除為範圍外)

### 未對應任務

**無** - 所有任務皆可追溯至功能需求或跨領域關注事項(測試、文件)。

---

## 準則符合性

**整體狀態**: ✅ 符合

### 準則逐項審查

| 準則 | 狀態 | 證據 | 問題 |
|-----------|--------|----------|--------|
| I. 繁體中文優先 | ✅ 通過 | spec.md、plan.md、tasks.md 全部使用繁體中文;提交訊息依例外條款使用英文 | 無 |
| II. 安全優先開發 | ✅ 通過 | JWT 認證、bcrypt 雜湊、審計記錄(FR-024/FR-025)、RBAC 強制執行、帳號鎖定、HTTPS 需求皆已指定 | 無 |
| III. 測試覆蓋率要求 | ✅ 通過 | tasks.md 包含 17+ 個測試任務橫跨單元/整合/RBAC 測試;涵蓋目標定義於 tasks.md:L305-310 (符合準則 80%+ 要求) | 無 |
| IV. API 優先架構 | ✅ 通過 | 後端(CodeIgniter REST API) + 前端(Nuxt 3)解耦;plan.md 指定 OpenAPI 契約(L101-103) | 無 |
| V. 程式碼品質與可維護性 | ✅ 通過 | Traits (HasRbacPermissions)、composables (useApi、useAuth)、測試 fixtures、強調程式碼重用 | 無 |

**準則違規**: 無

---

## 架構與設計一致性

### 規格 ↔ 計畫對齊

| 面向 | 規格參照 | 計畫參照 | 狀態 |
|--------|----------------|----------------|--------|
| 技術堆疊 | L172-182 (CodeIgniter 4、Nuxt 3、MariaDB) | L28-46 (符合規格) | ✅ 對齊 |
| 認證 | FR-001、FR-003、FR-004 (JWT、bcrypt) | L20 (firebase/php-jwt) | ✅ 對齊 |
| 使用者角色 | FR-002 (4 種角色: admin/chairman/member/observer) | L14 (符合規格) | ✅ 對齊 |
| 會話過期 | FR-003 (24h)、FR-004 (7d) | L57-58 (符合規格) | ✅ 對齊 |
| 審計記錄 | FR-024/FR-025 (審計資料表或結構化日誌) | L121 (AuthenticationEventModel.php - 確定為資料表) | ⚠️ 規格模糊,計畫明確 |

### 計畫 ↔ 任務對齊

| 計畫元件 | 任務參照 | 狀態 |
|----------------|-----------------|--------|
| authentication_events 資料表 (plan.md:L128) | T004-T007 (遷移 + 模型 + 輔助函數) | ✅ 對齊 |
| HasRbacPermissions trait (plan.md:L124) | T008-T009 (trait 建立) | ✅ 對齊 |
| SessionCleanup 指令 (plan.md:L135) | T010, T036-T037 (指令 + 驗證) | ✅ 對齊 |
| 自動 token 更新 (plan.md:L204) | T032-T035, T038 (前端 plugin + 測試) | ✅ 對齊 |
| Cron 容器 (plan.md:L165) | T001-T003 (Dockerfile + crontab + docker-compose) | ✅ 對齊 |

**重大不一致**: 無關鍵問題;參見發現表中的 I2(審計記錄方法)和 I3(未使用 user_permissions 資料表)。

---

## 使用者故事驗證

### 故事獨立性檢查

| 使用者故事 | 相依性 | 獨立? | 測試驗證 |
|------------|--------------|--------------|-------------------|
| US1 (管理員登入) | Phase 2 (基礎設施) | ✅ 是 | Phase 3 後檢查點 (tasks.md:L80) |
| US2 (一般使用者登入) | Phase 2 (基礎設施) | ✅ 是 | Phase 4 後檢查點 (tasks.md:L110) |
| US3 (會話管理) | Phase 2 (基礎設施) | ✅ 是 | Phase 5 後檢查點 (tasks.md:L137) |
| US4 (路由保護) | Phase 2 (基礎設施), 與 US2 共享 RBAC | ⚠️ 大部分 | Phase 6 後檢查點 (tasks.md:L158) |

**分析**: 故事獨立性維持良好。US4 與 US2 共享 RBAC 基礎設施但可獨立測試(不同測試情境)。

### 驗收標準完整性

| 故事 | 總情境數 | 可測試? | 已對應至任務? | 問題 |
|-------|-----------------|-----------|------------------|--------|
| US1 | 5 個情境 | ✅ 是 | ✅ T019 (AdminPermissionsTest) | 無 |
| US2 | 7 個情境 | ✅ 是 | ✅ T027-T030 (角色特定測試) | 無 |
| US3 | 5 個情境 | ✅ 是 | ✅ T038 (useApi.spec.js) | 無 |
| US4 | 5 個情境 | ✅ 是 | ✅ T043-T044 (RolePermissionTest) | 無 |

**所有驗收標準皆可測試且有對應的測試任務。**

---

## 指標摘要

### 量化指標

| 指標 | 數值 | 目標 | 狀態 |
|--------|-------|--------|--------|
| 功能需求總數 | 26 | N/A | ℹ️ |
| 使用者故事總數 | 4 | N/A | ℹ️ |
| 驗收情境總數 | 22 | N/A | ℹ️ |
| 任務總數 | 54 | N/A | ℹ️ |
| 有 ≥1 任務的需求 | 25/26 | 100% | ⚠️ 96% (FR-020 範圍外) |
| 有需求對應的任務 | 54/54 | 100% | ✅ 100% |
| 關鍵問題 | 0 | 0 | ✅ 通過 |
| 高優先級問題 | 3 | <5 | ✅ 通過 |
| 中優先級問題 | 5 | <10 | ✅ 通過 |
| 測試任務 | 17/54 | >30% | ✅ 31% |
| 可並行任務 | 36/54 | >50% | ✅ 67% |

### 質性評估

**優勢**:
- ✅ 按使用者故事階段清晰組織任務
- ✅ 為獨立故事驗證設定明確檢查點
- ✅ 全面的測試覆蓋規劃(17 個測試任務)
- ✅ 高並行化潛力(36/54 任務標記為 [P])
- ✅ 明確定義的 MVP 範圍(Phase 1-3, 19 個任務)
- ✅ 準則符合性無違規
- ✅ 所有使用者故事的詳細驗收標準

**弱點**:
- ⚠️ 非關鍵需求中的輕微模糊性(A1、A2、A3)
- ⚠️ FR-020 包含在功能需求中但標記為未來工作(應在範圍外)
- ⚠️ 文件間術語不一致(會話 token vs session token vs JWT token)
- ⚠️ 某些邊緣案例提及不在需求中的功能(例如 "登出所有裝置")

---

## 後續行動

### 執行 `/implement` 之前

**必須處理(高優先級)**:
1. **[U1]** 將 FR-020 (密碼重置) 移至 "範圍外" 區塊,或從功能需求中完全移除
2. **[A1]** 在 FR-024 中新增審計日誌保留政策(例如:"保留 90 天" 或指定無限期保留)
3. **[A2]/[I1]** 統一 spec.md FR-026、澄清事項和 tasks.md T002 的會話清理排程為單一值:"每日凌晨 2:00 執行"

**應該處理(中優先級)**:
4. **[D1]** 整合關於會話無效化的重複邊緣案例(spec.md:L94-98)
5. **[I2]** 更新 spec.md FR-024 移除模糊性:"專用審計資料表 (authentication_events)" 而非 "或結構化應用程式日誌"
6. **[I3]** 澄清 user_permissions 資料表用途 - 在 spec.md 中新增說明是既有基礎設施或從關鍵實體中移除
7. **[T1]** 標準化術語:首次提及使用 "會話 token (JWT)",之後一致使用 "會話 token"
8. **[C1]** 在 Phase 7 新增 FR-023 的明確測試任務以驗證敏感欄位排除

**可以處理(低優先級)**:
9. **[C2]** 確保 T018 (AuthControllerTest) 明確測試 login_attempts 計數器重置
10. **[A3]** tasks.md 已處理(T034-T035 顯示主動 + 被動更新) - 無需行動
11. **[A4]** 如需要 "登出所有裝置" 功能,新增 FR-027;否則從邊緣案例中移除

### 進行實作

**高優先級問題解決後**,您可以安全地進行:

```bash
/speckit.implement
```

**建議的實作策略**:
- **快速 MVP**: 執行 Phase 1 (設定) → Phase 2 (基礎) → Phase 3 (使用者故事 1) = 19 個任務
- **完整功能**: 依序執行 Phase 1-7 或在 Phase 2 檢查點後並行化使用者故事

---

## 修復建議

您希望我為上述列出的前 8 個高/中優先級問題提供具體的修復編輯建議嗎?

如果批准,我可以準備確切的檔案編輯以:
- 將 FR-020 移至範圍外區塊
- 在 FR-024 新增保留政策
- 統一清理排程為 "每日凌晨 2:00"
- 更新術語並整合邊緣案例
- 澄清 authentication_events 資料表承諾

**請確認您希望自動化修復建議還是偏好手動處理這些發現。**

---

## 分析元資料

**分析方法**: 漸進式揭露文件載入 + 語義需求對應 + 準則交叉參照
**信心層級**: 高(三個核心文件皆存在且格式良好)
**確定性**: ✅ 是(重新執行應產生相同發現)
**Token 效率**: 約消耗 17K tokens (文件 + 分析輸出)

**產生者**: Claude Code `/speckit.analyze` 指令
**報告版本**: 1.0
**準則版本**: 1.0.0 (批准於 2025-10-24)
