#!/bin/bash

# Urban Renewal Voting System - çµ±ä¸€ç’°å¢ƒç®¡ç†è…³æœ¬
# éƒ½æ›´è¨ˆç¥¨ç³»çµ± - ç’°å¢ƒç®¡ç†
#
# ä½¿ç”¨æ–¹å¼ï¼š
#   ./scripts/deploy.sh production  # å•Ÿå‹•æ­£å¼ç’°å¢ƒ
#   ./scripts/deploy.sh dev        # å•Ÿå‹•é–‹ç™¼ç’°å¢ƒ
#   ./scripts/deploy.sh            # é è¨­é–‹ç™¼ç’°å¢ƒ

set -e

# é¡è‰²å®šç¾©
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m' # No Color

# æ¥æ”¶ç’°å¢ƒåƒæ•¸ï¼Œé è¨­ç‚º dev
ENV=${1:-dev}

echo -e "${BLUE}========================================${NC}"
echo -e "${BLUE}  éƒ½æ›´è¨ˆç¥¨ç³»çµ± - ç’°å¢ƒå•Ÿå‹•${NC}"
echo -e "${BLUE}========================================${NC}"
echo ""

# æª¢æŸ¥ç’°å¢ƒåƒæ•¸
if [[ "$ENV" != "production" && "$ENV" != "dev" ]]; then
    echo -e "${RED}âŒ éŒ¯èª¤ï¼šä¸æ”¯æ´çš„ç’°å¢ƒ '$ENV'${NC}"
    echo -e "${YELLOW}æ”¯æ´çš„ç’°å¢ƒï¼šproduction, dev${NC}"
    exit 1
fi

echo -e "${GREEN}ğŸ“¦ ç›®æ¨™ç’°å¢ƒï¼š${ENV}${NC}"
echo ""

# æª¢æŸ¥ç’°å¢ƒé…ç½®æª”æ¡ˆ
ENV_FILE="docker/.env.$ENV"
if [ ! -f "$ENV_FILE" ]; then
    echo -e "${RED}âŒ ç’°å¢ƒé…ç½®æª”æ¡ˆä¸å­˜åœ¨: $ENV_FILE${NC}"
    exit 1
fi

echo -e "${GREEN}âœ“ æ‰¾åˆ°ç’°å¢ƒé…ç½®æª”æ¡ˆ: $ENV_FILE${NC}"

# è¤‡è£½ç’°å¢ƒé…ç½®åˆ° docker/.env
echo -e "${BLUE}ğŸ“‹ è¤‡è£½ç’°å¢ƒé…ç½®...${NC}"
cp "$ENV_FILE" docker/.env
echo -e "${GREEN}âœ“ å·²è¤‡è£½åˆ° docker/.env${NC}"

# ç”Ÿæˆ backend/.env
echo -e "${BLUE}ğŸ”§ ç”Ÿæˆå¾Œç«¯é…ç½® backend/.env...${NC}"

# å¾ docker/.env è®€å–è®Šæ•¸
source docker/.env

# ç”Ÿæˆ CodeIgniter 4 æ ¼å¼çš„ .env
cat > backend/.env << EOF
# Auto-generated from docker/.env.$ENV
# Generated at: $(date '+%Y-%m-%d %H:%M:%S')
# DO NOT EDIT MANUALLY - This file is auto-generated by scripts/deploy.sh

CI_ENVIRONMENT = $CI_ENVIRONMENT

#--------------------------------------------------------------------
# DATABASE
#--------------------------------------------------------------------
database.default.hostname = $DB_HOST
database.default.database = $DB_DATABASE
database.default.username = $DB_USERNAME
database.default.password = $DB_PASSWORD
database.default.DBDriver = MySQLi
database.default.DBPrefix =
database.default.port = 3306

#--------------------------------------------------------------------
# DEBUG
#--------------------------------------------------------------------
# Debug level: 0=off, 1=error, 2=debug, 3=info, 4=all
CI.debug = $CI_DEBUG
EOF

echo -e "${GREEN}âœ“ å·²ç”Ÿæˆ backend/.env${NC}"
echo ""

# é¡¯ç¤ºé…ç½®æ‘˜è¦
echo -e "${BLUE}ğŸ“Š é…ç½®æ‘˜è¦ï¼š${NC}"
echo -e "  ç’°å¢ƒ: ${YELLOW}$CI_ENVIRONMENT${NC}"
echo -e "  è³‡æ–™åº«ä¸»æ©Ÿ: ${YELLOW}$DB_HOST${NC}"
echo -e "  è³‡æ–™åº«åç¨±: ${YELLOW}$DB_DATABASE${NC}"
echo -e "  è³‡æ–™åº«ä½¿ç”¨è€…: ${YELLOW}$DB_USERNAME${NC}"
echo -e "  Debug ç­‰ç´š: ${YELLOW}$CI_DEBUG${NC}"
echo ""

# æª¢æŸ¥ docker-compose æª”æ¡ˆ
COMPOSE_FILE="docker/docker-compose.$ENV.yml"
if [ ! -f "$COMPOSE_FILE" ]; then
    echo -e "${RED}âŒ Docker Compose æª”æ¡ˆä¸å­˜åœ¨: $COMPOSE_FILE${NC}"
    exit 1
fi

echo -e "${GREEN}âœ“ æ‰¾åˆ° Docker Compose æª”æ¡ˆ: $COMPOSE_FILE${NC}"
echo ""

# æª¢æŸ¥ä¸¦æ¸…ç†èˆŠå®¹å™¨
echo -e "${BLUE}ğŸ” æª¢æŸ¥èˆŠå®¹å™¨...${NC}"

# æ ¹æ“šç’°å¢ƒè¨­å®šå®¹å™¨åç¨±æ¨¡å¼
if [ "$ENV" = "production" ]; then
    CONTAINER_PATTERN="urban_renewal_.*_prod"
else
    CONTAINER_PATTERN="urban_renewal_.*_dev"
fi

# æª¢æŸ¥æ˜¯å¦å­˜åœ¨ç›¸é—œå®¹å™¨ï¼ˆåŒ…å«å·²åœæ­¢çš„ï¼‰
EXISTING_CONTAINERS=$(docker ps -aq --filter "name=${CONTAINER_PATTERN}" 2>/dev/null)

if [ -n "$EXISTING_CONTAINERS" ]; then
    echo -e "${YELLOW}âš ï¸  ç™¼ç¾èˆŠå®¹å™¨ï¼Œæ­£åœ¨æ¸…ç†...${NC}"
    
    # é¡¯ç¤ºè¦æ¸…ç†çš„å®¹å™¨
    echo -e "${YELLOW}   å®¹å™¨åˆ—è¡¨:${NC}"
    docker ps -a --filter "name=${CONTAINER_PATTERN}" --format "   - {{.Names}} ({{.Status}})" 2>/dev/null || true
    
    # åœæ­¢ä¸¦ç§»é™¤æ‰€æœ‰ç›¸é—œå®¹å™¨
    echo -e "${YELLOW}   æ­£åœ¨åœæ­¢ä¸¦ç§»é™¤...${NC}"
    docker rm -f $EXISTING_CONTAINERS 2>/dev/null || true
    
    # å†æ¬¡æª¢æŸ¥æ˜¯å¦æ¸…ç†ä¹¾æ·¨
    REMAINING=$(docker ps -aq --filter "name=${CONTAINER_PATTERN}" 2>/dev/null)
    if [ -n "$REMAINING" ]; then
        echo -e "${RED}âš ï¸  éƒ¨åˆ†å®¹å™¨æ¸…ç†å¤±æ•—ï¼Œå˜—è©¦å¼·åˆ¶æ¸…ç†...${NC}"
        docker rm -f $REMAINING 2>/dev/null || true
    fi
    
    echo -e "${GREEN}âœ“ èˆŠå®¹å™¨å·²æ¸…ç†${NC}"
else
    echo -e "${GREEN}âœ“ ç„¡èˆŠå®¹å™¨${NC}"
fi

# æ¸…ç†èˆŠçš„ç¶²è·¯ï¼ˆå¦‚æœå­˜åœ¨ï¼‰
OLD_NETWORK=$(docker network ls --filter "name=docker_urban_renewal_network" -q 2>/dev/null)
if [ -n "$OLD_NETWORK" ]; then
    echo -e "${YELLOW}âš ï¸  ç™¼ç¾èˆŠç¶²è·¯ï¼Œæ­£åœ¨æ¸…ç†...${NC}"
    docker network rm docker_urban_renewal_network 2>/dev/null || true
fi

echo ""

# æª¢æŸ¥å‰ç«¯æ˜¯å¦æœ‰è®Šæ›´
check_frontend_changes() {
    # æª¢æŸ¥æ˜¯å¦å­˜åœ¨å‰ç«¯ image
    FRONTEND_IMAGE=$(docker images -q docker-frontend 2>/dev/null)
    
    if [ -z "$FRONTEND_IMAGE" ]; then
        echo -e "${YELLOW}âš ï¸  å‰ç«¯ image ä¸å­˜åœ¨ï¼Œéœ€è¦ build${NC}"
        return 0  # éœ€è¦ build
    fi
    
    # æª¢æŸ¥å‰ç«¯æª”æ¡ˆæ˜¯å¦æœ‰è®Šæ›´ï¼ˆèˆ‡ä¸Šæ¬¡ build æ¯”è¼ƒï¼‰
    FRONTEND_HASH_FILE=".frontend_build_hash"
    CURRENT_HASH=$(find frontend -type f \( -name "*.vue" -o -name "*.ts" -o -name "*.js" -o -name "package.json" \) -exec md5sum {} \; 2>/dev/null | sort | md5sum | cut -d' ' -f1)
    
    if [ -f "$FRONTEND_HASH_FILE" ]; then
        LAST_HASH=$(cat "$FRONTEND_HASH_FILE")
        if [ "$CURRENT_HASH" = "$LAST_HASH" ]; then
            echo -e "${GREEN}âœ“ å‰ç«¯ç„¡è®Šæ›´ï¼Œè·³é build${NC}"
            return 1  # ä¸éœ€è¦ build
        fi
    fi
    
    echo -e "${YELLOW}âš ï¸  å‰ç«¯æœ‰è®Šæ›´ï¼Œéœ€è¦ build${NC}"
    echo "$CURRENT_HASH" > "$FRONTEND_HASH_FILE"
    return 0  # éœ€è¦ build
}

# æ™ºèƒ½æª¢æ¸¬å‰ç«¯è®Šæ›´
echo -e "${BLUE}ğŸ” æª¢æŸ¥å‰ç«¯è®Šæ›´...${NC}"
if check_frontend_changes; then
    echo -e "${BLUE}ğŸ”¨ Build å‰ç«¯ image...${NC}"
    docker compose -f "$COMPOSE_FILE" build frontend
    echo -e "${GREEN}âœ“ å‰ç«¯ build å®Œæˆ${NC}"
fi
echo ""

# å•Ÿå‹• Docker Compose
echo -e "${BLUE}ğŸš€ å•Ÿå‹• Docker æœå‹™...${NC}"
echo -e "${YELLOW}åŸ·è¡ŒæŒ‡ä»¤: docker compose -f $COMPOSE_FILE --env-file docker/.env up -d${NC}"
echo ""

docker compose -f "$COMPOSE_FILE" --env-file docker/.env up -d

echo ""
echo -e "${GREEN}========================================${NC}"
echo -e "${GREEN}  âœ“ å•Ÿå‹•å®Œæˆï¼${NC}"
echo -e "${GREEN}========================================${NC}"
echo ""

# ç­‰å¾…å¾Œç«¯å®¹å™¨å®Œå…¨å•Ÿå‹•
echo -e "${BLUE}â³ ç­‰å¾…å¾Œç«¯å®¹å™¨å•Ÿå‹•...${NC}"
sleep 5

# åŸ·è¡Œè³‡æ–™åº«é·ç§»
echo -e "${BLUE}ğŸ”„ åŸ·è¡Œè³‡æ–™åº«é·ç§»...${NC}"
BACKEND_CONTAINER="urban_renewal_backend_${ENV}"

# æª¢æŸ¥å®¹å™¨æ˜¯å¦å­˜åœ¨ä¸”æ­£åœ¨é‹è¡Œ
if docker ps --format '{{.Names}}' | grep -q "^${BACKEND_CONTAINER}$"; then
    echo -e "${YELLOW}   åŸ·è¡ŒæŒ‡ä»¤: docker exec ${BACKEND_CONTAINER} php spark migrate --all${NC}"
    
    # åŸ·è¡Œ migrate
    if docker exec "$BACKEND_CONTAINER" php spark migrate --all 2>&1 | tee /tmp/migrate_output.log; then
        echo -e "${GREEN}âœ“ è³‡æ–™åº«é·ç§»å®Œæˆ${NC}"
    else
        # æª¢æŸ¥æ˜¯å¦æ˜¯ "æ²’æœ‰æ–°çš„é·ç§»" çš„æƒ…æ³
        if grep -q "Nothing to migrate" /tmp/migrate_output.log 2>/dev/null; then
            echo -e "${GREEN}âœ“ è³‡æ–™åº«å·²æ˜¯æœ€æ–°ç‰ˆæœ¬${NC}"
        else
            echo -e "${YELLOW}âš ï¸  è³‡æ–™åº«é·ç§»æœ‰è­¦å‘Šï¼Œè«‹æª¢æŸ¥æ—¥èªŒ${NC}"
        fi
    fi
    rm -f /tmp/migrate_output.log 2>/dev/null || true
else
    echo -e "${RED}âš ï¸  æ‰¾ä¸åˆ°å¾Œç«¯å®¹å™¨: ${BACKEND_CONTAINER}${NC}"
    echo -e "${YELLOW}   è«‹æ‰‹å‹•åŸ·è¡Œ: docker exec ${BACKEND_CONTAINER} php spark migrate --all${NC}"
fi
echo ""

# é¡¯ç¤ºæœå‹™ç‹€æ…‹
echo -e "${BLUE}ğŸ“‹ æœå‹™ç‹€æ…‹ï¼š${NC}"
docker compose -f "$COMPOSE_FILE" --env-file docker/.env ps

echo ""
echo -e "${BLUE}ğŸ’¡ å¸¸ç”¨æŒ‡ä»¤ï¼š${NC}"
echo -e "  æŸ¥çœ‹æ—¥èªŒ: ${YELLOW}docker compose -f $COMPOSE_FILE logs -f${NC}"
echo -e "  åœæ­¢æœå‹™: ${YELLOW}docker compose -f $COMPOSE_FILE down${NC}"
echo -e "  é‡å•Ÿæœå‹™: ${YELLOW}./scripts/deploy.sh $ENV${NC}"
echo -e "  åŸ·è¡Œé·ç§»: ${YELLOW}docker exec ${BACKEND_CONTAINER} php spark migrate --all${NC}"
echo ""
