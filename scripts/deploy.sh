#!/bin/bash

# Urban Renewal Voting System - çµ±ä¸€ç’°å¢ƒç®¡ç†è…³æœ¬
# éƒ½æ›´è¨ˆç¥¨ç³»çµ± - ç’°å¢ƒç®¡ç†
#
# ä½¿ç”¨æ–¹å¼ï¼š
#   ./scripts/deploy.sh production  # å•Ÿå‹•æ­£å¼ç’°å¢ƒ
#   ./scripts/deploy.sh dev        # å•Ÿå‹•é–‹ç™¼ç’°å¢ƒ
#   ./scripts/deploy.sh            # é è¨­é–‹ç™¼ç’°å¢ƒ

set -e

# é¡è‰²å®šç¾©
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m' # No Color

# æ¥æ”¶ç’°å¢ƒåƒæ•¸ï¼Œé è¨­ç‚º dev
ENV=${1:-dev}

echo -e "${BLUE}========================================${NC}"
echo -e "${BLUE}  éƒ½æ›´è¨ˆç¥¨ç³»çµ± - ç’°å¢ƒå•Ÿå‹•${NC}"
echo -e "${BLUE}========================================${NC}"
echo ""

# æª¢æŸ¥ç’°å¢ƒåƒæ•¸
if [[ "$ENV" != "production" && "$ENV" != "dev" ]]; then
    echo -e "${RED}âŒ éŒ¯èª¤ï¼šä¸æ”¯æ´çš„ç’°å¢ƒ '$ENV'${NC}"
    echo -e "${YELLOW}æ”¯æ´çš„ç’°å¢ƒï¼šproduction, dev${NC}"
    exit 1
fi

echo -e "${GREEN}ğŸ“¦ ç›®æ¨™ç’°å¢ƒï¼š${ENV}${NC}"
echo ""

# æª¢æŸ¥ç’°å¢ƒé…ç½®æª”æ¡ˆ
ENV_FILE="docker/.env.$ENV"
if [ ! -f "$ENV_FILE" ]; then
    echo -e "${RED}âŒ ç’°å¢ƒé…ç½®æª”æ¡ˆä¸å­˜åœ¨: $ENV_FILE${NC}"
    exit 1
fi

echo -e "${GREEN}âœ“ æ‰¾åˆ°ç’°å¢ƒé…ç½®æª”æ¡ˆ: $ENV_FILE${NC}"

# è¤‡è£½ç’°å¢ƒé…ç½®åˆ° docker/.env
echo -e "${BLUE}ğŸ“‹ è¤‡è£½ç’°å¢ƒé…ç½®...${NC}"
cp "$ENV_FILE" docker/.env
echo -e "${GREEN}âœ“ å·²è¤‡è£½åˆ° docker/.env${NC}"

# ç”Ÿæˆ backend/.env
echo -e "${BLUE}ğŸ”§ ç”Ÿæˆå¾Œç«¯é…ç½® backend/.env...${NC}"

# å¾ docker/.env è®€å–è®Šæ•¸
source docker/.env

# ç”Ÿæˆ CodeIgniter 4 æ ¼å¼çš„ .env
cat > backend/.env << EOF
# Auto-generated from docker/.env.$ENV
# Generated at: $(date '+%Y-%m-%d %H:%M:%S')
# DO NOT EDIT MANUALLY - This file is auto-generated by scripts/deploy.sh

CI_ENVIRONMENT = $CI_ENVIRONMENT

#--------------------------------------------------------------------
# DATABASE
#--------------------------------------------------------------------
database.default.hostname = $DB_HOST
database.default.database = $DB_DATABASE
database.default.username = $DB_USERNAME
database.default.password = $DB_PASSWORD
database.default.DBDriver = MySQLi
database.default.DBPrefix =
database.default.port = 3306

#--------------------------------------------------------------------
# DEBUG
#--------------------------------------------------------------------
# Debug level: 0=off, 1=error, 2=debug, 3=info, 4=all
CI.debug = $CI_DEBUG
EOF

echo -e "${GREEN}âœ“ å·²ç”Ÿæˆ backend/.env${NC}"
echo ""

# é¡¯ç¤ºé…ç½®æ‘˜è¦
echo -e "${BLUE}ğŸ“Š é…ç½®æ‘˜è¦ï¼š${NC}"
echo -e "  ç’°å¢ƒ: ${YELLOW}$CI_ENVIRONMENT${NC}"
echo -e "  è³‡æ–™åº«ä¸»æ©Ÿ: ${YELLOW}$DB_HOST${NC}"
echo -e "  è³‡æ–™åº«åç¨±: ${YELLOW}$DB_DATABASE${NC}"
echo -e "  è³‡æ–™åº«ä½¿ç”¨è€…: ${YELLOW}$DB_USERNAME${NC}"
echo -e "  Debug ç­‰ç´š: ${YELLOW}$CI_DEBUG${NC}"
echo ""

# æª¢æŸ¥ docker-compose æª”æ¡ˆ
COMPOSE_FILE="docker/docker-compose.$ENV.yml"
if [ ! -f "$COMPOSE_FILE" ]; then
    echo -e "${RED}âŒ Docker Compose æª”æ¡ˆä¸å­˜åœ¨: $COMPOSE_FILE${NC}"
    exit 1
fi

echo -e "${GREEN}âœ“ æ‰¾åˆ° Docker Compose æª”æ¡ˆ: $COMPOSE_FILE${NC}"
echo ""

# æª¢æŸ¥ä¸¦æ¸…ç†èˆŠå®¹å™¨
echo -e "${BLUE}ğŸ” æª¢æŸ¥èˆŠå®¹å™¨...${NC}"
EXISTING_CONTAINERS=$(docker compose -f "$COMPOSE_FILE" ps -aq 2>/dev/null)

if [ -n "$EXISTING_CONTAINERS" ]; then
    echo -e "${YELLOW}âš ï¸  ç™¼ç¾èˆŠå®¹å™¨ï¼Œæ­£åœ¨æ¸…ç†...${NC}"
    
    # åœæ­¢ä¸¦ç§»é™¤èˆŠå®¹å™¨
    docker compose -f "$COMPOSE_FILE" down 2>/dev/null || true
    
    # é¡å¤–æª¢æŸ¥æ˜¯å¦æœ‰æ®˜ç•™çš„å®¹å™¨ï¼ˆä½¿ç”¨ç›¸åŒåç¨±ï¼‰
    ORPHAN_CONTAINERS=$(docker ps -aq --filter "name=urban_renewal_.*_${ENV}" 2>/dev/null)
    if [ -n "$ORPHAN_CONTAINERS" ]; then
        echo -e "${YELLOW}âš ï¸  ç™¼ç¾æ®˜ç•™å®¹å™¨ï¼Œæ­£åœ¨å¼·åˆ¶ç§»é™¤...${NC}"
        docker rm -f $ORPHAN_CONTAINERS 2>/dev/null || true
    fi
    
    echo -e "${GREEN}âœ“ èˆŠå®¹å™¨å·²æ¸…ç†${NC}"
else
    echo -e "${GREEN}âœ“ ç„¡èˆŠå®¹å™¨${NC}"
fi
echo ""

# å•Ÿå‹• Docker Compose
echo -e "${BLUE}ğŸš€ å•Ÿå‹• Docker æœå‹™...${NC}"
echo -e "${YELLOW}åŸ·è¡ŒæŒ‡ä»¤: docker compose -f $COMPOSE_FILE --env-file docker/.env up -d --build${NC}"
echo ""

docker compose -f "$COMPOSE_FILE" --env-file docker/.env up -d --build

echo ""
echo -e "${GREEN}========================================${NC}"
echo -e "${GREEN}  âœ“ å•Ÿå‹•å®Œæˆï¼${NC}"
echo -e "${GREEN}========================================${NC}"
echo ""

# é¡¯ç¤ºæœå‹™ç‹€æ…‹
echo -e "${BLUE}ğŸ“‹ æœå‹™ç‹€æ…‹ï¼š${NC}"
docker compose -f "$COMPOSE_FILE" --env-file docker/.env ps

echo ""
echo -e "${BLUE}ğŸ’¡ å¸¸ç”¨æŒ‡ä»¤ï¼š${NC}"
echo -e "  æŸ¥çœ‹æ—¥èªŒ: ${YELLOW}docker compose -f $COMPOSE_FILE logs -f${NC}"
echo -e "  åœæ­¢æœå‹™: ${YELLOW}docker compose -f $COMPOSE_FILE down${NC}"
echo -e "  é‡å•Ÿæœå‹™: ${YELLOW}./scripts/deploy.sh $ENV${NC}"
echo ""
