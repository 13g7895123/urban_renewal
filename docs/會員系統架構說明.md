# 會員系統架構說明

## 目錄
- [系統概述](#系統概述)
- [資料庫架構](#資料庫架構)
- [後端架構](#後端架構)
- [前端架構](#前端架構)
- [認證機制](#認證機制)
- [角色與權限](#角色與權限)
- [API 端點](#api-端點)
- [安全機制](#安全機制)
- [檔案路徑參考](#檔案路徑參考)

---

## 系統概述

本會員系統是一個基於 JWT 認證的完整使用者管理系統，支援多角色權限控制、企業使用者管理、會話追蹤等功能。

### 技術棧
- **後端**：CodeIgniter 4
- **前端**：Nuxt 3 + Pinia
- **認證**：JWT (JSON Web Token)
- **資料庫**：MySQL

### 核心功能
- 使用者註冊與登入
- JWT Token 認證
- 角色基礎存取控制 (RBAC)
- 企業使用者管理
- 會話管理
- 密碼重設
- 使用者個人資料管理

---

## 資料庫架構

### 1. users 表格

主要儲存使用者資料的核心表格。

#### 基本欄位
| 欄位名稱 | 類型 | 說明 |
|---------|------|------|
| `id` | BIGINT | 主鍵（自動遞增） |
| `username` | VARCHAR(50) | 使用者帳號（唯一） |
| `email` | VARCHAR(100) | 電子郵件（唯一） |
| `password_hash` | VARCHAR(255) | 加密後的密碼 |

#### 角色與關聯
| 欄位名稱 | 類型 | 說明 |
|---------|------|------|
| `role` | ENUM | 角色：admin/chairman/member/observer |
| `urban_renewal_id` | BIGINT | 所屬更新會 ID |
| `property_owner_id` | BIGINT | 關聯的地主 ID |

#### 個人資訊
| 欄位名稱 | 類型 | 說明 |
|---------|------|------|
| `full_name` | VARCHAR(100) | 真實姓名 |
| `nickname` | VARCHAR(50) | 暱稱 |
| `phone` | VARCHAR(20) | 手機號碼 |
| `line_account` | VARCHAR(100) | LINE 帳號 |
| `position` | VARCHAR(100) | 職稱 |

#### 使用者類型（企業功能）
| 欄位名稱 | 類型 | 說明 |
|---------|------|------|
| `user_type` | ENUM | 使用者類型：general/enterprise |
| `is_company_manager` | BOOLEAN | 是否為企業管理者 |

#### 安全機制
| 欄位名稱 | 類型 | 說明 |
|---------|------|------|
| `is_active` | BOOLEAN | 帳號是否啟用 |
| `login_attempts` | INT | 登入失敗次數 |
| `locked_until` | DATETIME | 帳號鎖定到期時間 |

#### 密碼重設
| 欄位名稱 | 類型 | 說明 |
|---------|------|------|
| `password_reset_token` | VARCHAR(255) | 密碼重設令牌 |
| `password_reset_expires` | DATETIME | 令牌過期時間 |

#### 時間戳記
| 欄位名稱 | 類型 | 說明 |
|---------|------|------|
| `created_at` | DATETIME | 建立時間 |
| `updated_at` | DATETIME | 更新時間 |
| `deleted_at` | DATETIME | 軟刪除時間 |
| `last_login_at` | DATETIME | 最後登入時間 |

**Migration 檔案**：
- `backend/app/Database/Migrations/2025-01-01-000010_CreateUserAuthenticationTables.php`
- `backend/app/Database/Migrations/2025-10-26-000001_AddUserTypeFieldsToUsersTable.php`
- `backend/app/Database/Migrations/2025-11-01-114445_AddUserProfileFieldsToUsersTable.php`

---

### 2. user_sessions 表格

管理使用者登入會話。

| 欄位名稱 | 類型 | 說明 |
|---------|------|------|
| `id` | BIGINT | 主鍵 |
| `user_id` | BIGINT | 使用者 ID |
| `session_token` | VARCHAR(255) | Session Token |
| `refresh_token` | VARCHAR(255) | Refresh Token |
| `expires_at` | DATETIME | Token 過期時間 |
| `refresh_expires_at` | DATETIME | Refresh Token 過期時間 |
| `ip_address` | VARCHAR(45) | IP 位址 |
| `user_agent` | TEXT | 瀏覽器資訊 |
| `device_info` | TEXT | 裝置資訊 |
| `is_active` | BOOLEAN | 是否活躍 |
| `last_activity_at` | DATETIME | 最後活動時間 |
| `created_at` | DATETIME | 建立時間 |

**Migration 檔案**：`backend/app/Database/Migrations/2025-01-01-000010_CreateUserAuthenticationTables.php`

---

### 3. user_permissions 表格

細緻化權限控制。

| 欄位名稱 | 類型 | 說明 |
|---------|------|------|
| `id` | BIGINT | 主鍵 |
| `user_id` | BIGINT | 使用者 ID |
| `permission_type` | VARCHAR(50) | 權限類型 |
| `resource_id` | BIGINT | 資源 ID（nullable） |
| `granted_by` | BIGINT | 授權者 ID |
| `granted_at` | DATETIME | 授權時間 |
| `expires_at` | DATETIME | 過期時間（nullable） |

**權限類型範例**：
- `urban_renewal_manage` - 更新會管理
- `meeting_manage` - 會議管理
- `voting_manage` - 投票管理

**Migration 檔案**：`backend/app/Database/Migrations/2025-01-01-000010_CreateUserAuthenticationTables.php`

---

## 後端架構

### Models

#### UserModel (`backend/app/Models/UserModel.php`)

**CRUD 操作**：
- `createUser(array $data)` - 建立使用者
- `updateUser(int $id, array $data)` - 更新使用者
- `getUsers(array $filters = [])` - 取得使用者列表（支援分頁、篩選）
- `getUsersByUrbanRenewal(int $urbanRenewalId)` - 取得特定更新會的使用者

**搜尋功能**：
- `searchUsers(string $keyword, array $filters = [])` - 搜尋使用者
- `usernameExists(string $username, ?int $excludeId = null)` - 檢查帳號是否存在
- `emailExists(string $email, ?int $excludeId = null)` - 檢查信箱是否存在

**帳號管理**：
- `toggleUserStatus(int $id)` - 切換使用者啟用狀態
- `resetLoginAttempts(int $id)` - 重設登入失敗次數

**權限查詢**：
- `getUserWithPermissions(int $id)` - 取得使用者及其權限
- `getRoleStatistics()` - 取得角色統計資訊

**密碼處理**：
- `validatePasswordStrength(string $password)` - 驗證密碼強度
- `hashPassword(string $password)` - 密碼加密

**企業使用者管理**：
- `getCompanyManagers(int $companyId)` - 取得企業管理者列表
- `getCompanyUsers(int $companyId)` - 取得企業使用者列表
- `getAllCompanyMembers(int $companyId)` - 取得所有企業成員
- `setAsCompanyManager(int $userId, int $companyId)` - 設定為企業管理者
- `setAsCompanyUser(int $userId, int $companyId)` - 設定為企業使用者
- `isCompanyManager(int $userId)` - 檢查是否為企業管理者
- `canManageCompany(int $userId, int $companyId)` - 檢查是否可管理指定企業

---

#### UserSessionModel (`backend/app/Models/UserSessionModel.php`)

**Session 管理**：
- `cleanExpiredSessions()` - 清理過期 Sessions
- `getActiveSession(int $userId, string $sessionToken)` - 取得活躍 Session
- `updateActivity(int $sessionId)` - 更新活動時間
- `getUserActiveSessions(int $userId)` - 取得使用者所有活躍 Sessions
- `logoutAllUserSessions(int $userId)` - 登出所有 Sessions

---

### Controllers

#### AuthController (`backend/app/Controllers/Api/AuthController.php`)

處理認證相關的 API 請求。

**方法**：
- `login()` - 使用者登入
- `logout()` - 使用者登出
- `refresh()` - 刷新 Token
- `me()` - 取得當前使用者資訊
- `forgotPassword()` - 忘記密碼
- `resetPassword()` - 重設密碼

---

#### UserController (`backend/app/Controllers/Api/UserController.php`)

處理使用者管理相關的 API 請求。

**使用者 CRUD**：
- `index()` - 取得使用者列表
- `show($id)` - 取得使用者詳情
- `store()` - 建立使用者
- `update($id)` - 更新使用者
- `delete($id)` - 刪除使用者（軟刪除）

**其他功能**：
- `toggleStatus($id)` - 切換使用者狀態
- `resetLoginAttempts($id)` - 重設登入失敗次數
- `search()` - 搜尋使用者
- `roleStatistics()` - 角色統計
- `profile()` - 取得個人資料
- `changePassword()` - 變更密碼

**企業使用者管理**：
- `getCompanyManagers($companyId)` - 取得企業管理者
- `getCompanyUsers($companyId)` - 取得企業使用者
- `getCompanyMembers($companyId)` - 取得所有企業成員
- `setCompanyUser($id)` - 設定為企業使用者
- `setCompanyManager($id)` - 設定為企業管理者

---

### Helpers

#### auth_helper.php (`backend/app/Helpers/auth_helper.php`)

全域認證輔助函數。

**Token 處理**：
- `auth_validate_request()` - 驗證請求中的 JWT Token
- `auth_generate_token(array $payload)` - 產生 JWT Token
- `auth_generate_refresh_token()` - 產生 Refresh Token

**使用者資訊**：
- `auth_get_current_user()` - 取得當前認證使用者

**權限檢查**：
- `auth_check_permission(string $permission)` - 檢查使用者權限
- `auth_check_resource_scope(int $resourceId)` - 檢查資源存取範圍
- `auth_can_access_resource(string $resourceType, int $resourceId)` - 檢查資源存取權限

**企業使用者檢查**：
- `auth_is_company_manager()` - 檢查是否為企業管理者
- `auth_is_company_user()` - 檢查是否為企業使用者
- `auth_is_general_user()` - 檢查是否為一般使用者
- `auth_can_manage_company(int $companyId)` - 檢查是否可管理指定企業
- `auth_can_manage_user(int $userId)` - 檢查是否可管理指定使用者

---

### Filters

#### JWTAuthFilter (`backend/app/Filters/JWTAuthFilter.php`)

JWT 認證過濾器，自動驗證所有 API 請求的 Token。

**功能**：
- 驗證請求 Header 中的 `Authorization: Bearer {token}`
- 解碼並驗證 JWT Token
- 將使用者資訊注入請求物件
- Token 無效時返回 401 錯誤

---

## 前端架構

### Pages

#### login.vue (`frontend/pages/login.vue`)

登入頁面。

**功能**：
- 帳號、密碼輸入
- 密碼顯示/隱藏切換
- 登入成功後根據角色導向：
  - `admin` → `/tables/urban-renewal`
  - `chairman` / `member` → `/tables/meeting`
  - 其他 → `/`
- 使用 SweetAlert2 顯示錯誤訊息

**Middleware**：`guest`（已登入者重定向）

---

#### signup.vue (`frontend/pages/signup.vue`)

註冊頁面。

**功能**：
- **三步驟註冊流程**：
  1. 選擇帳號類型（個人/企業）
  2. 填寫資料
  3. 完成註冊

**個人帳號欄位**：
- 帳號、暱稱、密碼、確認密碼
- 姓名、信箱、手機、LINE
- 公司名稱、職稱

**企業帳號額外欄位**：
- 企業名稱、統一編號、企業電話

**驗證**：
- 表單驗證
- 密碼一致性檢查

**Middleware**：`guest`

---

#### pages/user.vue (`frontend/pages/pages/user.vue`)

使用者個人資料頁面。

**功能**：
- 顯示並編輯個人資料
- 欄位：帳號、姓名、暱稱、信箱、手機、LINE、公司名稱、職稱
- 變更密碼按鈕
- 儲存功能

---

### Stores

#### auth.js (`frontend/stores/auth.js`)

Pinia Store，管理全域認證狀態。

**State**：
```javascript
{
  user: null,           // 使用者資訊
  token: null,          // JWT Token
  refreshToken: null,   // Refresh Token
  tokenExpiresAt: null, // Token 過期時間
  isLoggedIn: false,    // 是否已登入
  isAdmin: false        // 是否為管理員
}
```

**主要方法**：
- `login(credentials)` - 登入並儲存 Token
- `logout()` - 登出並清除狀態
- `initializeAuth()` - 從 localStorage 初始化
- `fetchUser()` - 取得當前使用者資料
- `updateProfile(data)` - 更新使用者資料
- `changePassword(oldPassword, newPassword)` - 變更密碼
- `refreshAuthToken()` - 刷新 Token

**Token 輔助**：
- `decodeToken(token)` - 解碼 JWT
- `isTokenExpiringSoon(expiresAt)` - 檢查即將過期（5分鐘內）
- `isTokenExpired(expiresAt)` - 檢查已過期

---

### Composables

#### useAuth.js (`frontend/composables/useAuth.js`)

認證相關 API 呼叫。

**方法**：
- `login(credentials)` - 登入
- `logout()` - 登出
- `getCurrentUser()` - 取得當前使用者
- `refreshToken()` - 刷新 Token
- `requestPasswordReset(email)` - 請求密碼重設
- `resetPassword(token, password)` - 重設密碼
- `changePassword(oldPassword, newPassword)` - 變更密碼
- `updateProfile(data)` - 更新個人資料
- `checkAuth()` - 檢查認證狀態
- `validateToken()` - 驗證 Token

---

#### useUsers.js (`frontend/composables/useUsers.js`)

使用者管理相關 API 呼叫。

**方法**：
- `getUsers(params)` - 取得使用者列表
- `getUser(id)` - 取得單一使用者
- `createUser(data)` - 建立使用者
- `updateUser(id, data)` - 更新使用者
- `deleteUser(id)` - 刪除使用者
- `toggleUserStatus(id)` - 切換使用者狀態
- `changeUserPassword(id, password)` - 變更使用者密碼
- `restoreUser(id)` - 恢復已刪除使用者
- `forceDeleteUser(id)` - 永久刪除使用者
- `getUserStats()` - 取得使用者統計

---

### Middleware

#### auth.js (`frontend/middleware/auth.js`)

認證中間件。

**功能**：
- 檢查使用者是否已登入
- 未登入者重定向到 `/login`
- 僅在客戶端執行（避免 SSR 問題）

---

#### guest.js (`frontend/middleware/guest.js`)

訪客中間件。

**功能**：
- 已登入者重定向到首頁
- 用於登入、註冊頁面

---

#### role.js (`frontend/middleware/role.js`)

角色權限中間件。

**功能**：
- 檢查使用者角色
- 不符合要求者重定向到 `/unauthorized`
- 支援單一或多個角色驗證

**使用範例**：
```javascript
definePageMeta({
  middleware: ['auth', 'role'],
  role: 'admin' // 或 ['admin', 'chairman']
})
```

---

## 認證機制

### JWT Token 認證流程

```
1. 使用者登入
   ↓
2. 後端驗證帳號密碼
   ↓
3. 產生 JWT Token (24小時) 和 Refresh Token (7天)
   ↓
4. 前端儲存 Token 到 localStorage 和 Pinia Store
   ↓
5. API 請求時在 Header 帶入：Authorization: Bearer {token}
   ↓
6. 後端 JWTAuthFilter 驗證 Token
   ↓
7. Token 即將過期（5分鐘內）時使用 Refresh Token 更新
```

### JWT Payload 結構

```javascript
{
  "user_id": 123,
  "username": "john_doe",
  "role": "admin",
  "urban_renewal_id": 456,
  "iat": 1234567890,  // 發行時間
  "exp": 1234654290   // 過期時間
}
```

### Token 過期處理

- **JWT Token 有效期**：24 小時
- **Refresh Token 有效期**：7 天
- **自動刷新機制**：Token 過期前 5 分鐘自動使用 Refresh Token 更新
- **過期後處理**：清除登入狀態，重定向到登入頁面

---

## 角色與權限

### 使用者角色

| 角色 | 代碼 | 說明 | 權限範圍 |
|-----|------|------|---------|
| 系統管理員 | `admin` | 最高權限 | 全系統 |
| 理事長 | `chairman` | 更新會管理者 | 所屬更新會 |
| 會員 | `member` | 一般會員 | 所屬更新會 |
| 列席者 | `observer` | 觀察者 | 有限存取 |

### 使用者類型

| 類型 | 代碼 | 說明 |
|-----|------|------|
| 一般使用者 | `general` | 個人帳號 |
| 企業使用者 | `enterprise` | 企業帳號（含企業管理者） |

### 權限層級

1. **系統層級**：`admin` 可存取所有資源
2. **組織層級**：非 `admin` 僅能存取 `urban_renewal_id` 相關資源
3. **企業層級**：企業管理者可管理同企業的使用者
4. **資源層級**：透過 `user_permissions` 表格細緻控制

### 權限檢查範例

```php
// 檢查一般權限
if (!auth_check_permission('meeting_manage')) {
    return $this->failUnauthorized('無權限管理會議');
}

// 檢查資源範圍
if (!auth_check_resource_scope($urbanRenewalId)) {
    return $this->failUnauthorized('無權限存取此更新會');
}

// 檢查企業管理權限
if (!auth_can_manage_company($companyId)) {
    return $this->failUnauthorized('無權限管理此企業');
}
```

---

## API 端點

### 認證相關 (`/api/auth`)

| 方法 | 路徑 | 說明 | 需認證 |
|-----|------|------|--------|
| POST | `/api/auth/login` | 使用者登入 | ✗ |
| POST | `/api/auth/logout` | 使用者登出 | ✓ |
| POST | `/api/auth/refresh` | 刷新 Token | ✗ |
| GET | `/api/auth/me` | 取得當前使用者 | ✓ |
| POST | `/api/auth/forgot-password` | 忘記密碼 | ✗ |
| POST | `/api/auth/reset-password` | 重設密碼 | ✗ |

#### POST /api/auth/login

**請求**：
```json
{
  "username": "john_doe",
  "password": "password123"
}
```

**回應**：
```json
{
  "status": 200,
  "message": "登入成功",
  "data": {
    "user": {
      "id": 1,
      "username": "john_doe",
      "email": "john@example.com",
      "role": "admin",
      "full_name": "John Doe"
    },
    "token": "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...",
    "refreshToken": "abc123...",
    "expiresAt": "2025-11-02T12:00:00Z"
  }
}
```

**錯誤回應**：
- 帳號或密碼錯誤：`401 Unauthorized`
- 帳號被鎖定：`403 Forbidden`
- 帳號未啟用：`403 Forbidden`

---

### 使用者管理 (`/api/users`)

| 方法 | 路徑 | 說明 | 需認證 | 權限要求 |
|-----|------|------|--------|---------|
| GET | `/api/users` | 取得使用者列表 | ✓ | admin |
| GET | `/api/users/{id}` | 取得使用者詳情 | ✓ | admin |
| POST | `/api/users` | 建立使用者 | ✓ | admin |
| PUT | `/api/users/{id}` | 更新使用者 | ✓ | admin |
| DELETE | `/api/users/{id}` | 刪除使用者 | ✓ | admin |
| PATCH | `/api/users/{id}/toggle-status` | 切換狀態 | ✓ | admin |
| PATCH | `/api/users/{id}/reset-login-attempts` | 重設失敗次數 | ✓ | admin |
| GET | `/api/users/search` | 搜尋使用者 | ✓ | admin |
| GET | `/api/users/role-statistics` | 角色統計 | ✓ | admin |
| GET | `/api/users/profile` | 取得個人資料 | ✓ | - |
| POST | `/api/users/change-password` | 變更密碼 | ✓ | - |

#### GET /api/users

**查詢參數**：
- `page` - 頁碼（預設：1）
- `perPage` - 每頁筆數（預設：10）
- `role` - 角色篩選
- `urban_renewal_id` - 更新會篩選
- `is_active` - 啟用狀態篩選
- `search` - 關鍵字搜尋

**回應**：
```json
{
  "status": 200,
  "data": {
    "users": [...],
    "pagination": {
      "currentPage": 1,
      "perPage": 10,
      "total": 100,
      "totalPages": 10
    }
  }
}
```

---

### 企業使用者管理

| 方法 | 路徑 | 說明 | 需認證 |
|-----|------|------|--------|
| GET | `/api/users/company/{companyId}/managers` | 取得企業管理者 | ✓ |
| GET | `/api/users/company/{companyId}/users` | 取得企業使用者 | ✓ |
| GET | `/api/users/company/{companyId}/members` | 取得所有企業成員 | ✓ |
| PATCH | `/api/users/{id}/set-company-user` | 設定為企業使用者 | ✓ |
| PATCH | `/api/users/{id}/set-company-manager` | 設定為企業管理者 | ✓ |

---

## 安全機制

### 1. 密碼安全

**密碼強度要求**：
- 最少 8 個字元
- 至少包含 1 個大寫字母
- 至少包含 1 個小寫字母
- 至少包含 1 個數字

**密碼加密**：
- 使用 PHP `password_hash()` 函數
- 演算法：`PASSWORD_DEFAULT`（目前為 bcrypt）

**驗證範例**：
```php
$errors = $userModel->validatePasswordStrength($password);
if (!empty($errors)) {
    return $this->failValidationErrors($errors);
}

$hashedPassword = $userModel->hashPassword($password);
```

---

### 2. 登入保護

**失敗次數限制**：
- 最多失敗 5 次
- 鎖定時間：30 分鐘
- 自動解鎖

**登入流程**：
```
1. 檢查帳號是否鎖定
   ↓
2. 驗證帳號密碼
   ↓
3. 密碼錯誤 → 增加失敗次數
   ↓
4. 達到 5 次 → 鎖定帳號
   ↓
5. 密碼正確 → 重設失敗次數
```

---

### 3. Session 追蹤

**記錄資訊**：
- IP 位址
- User Agent（瀏覽器資訊）
- 裝置資訊
- 登入時間
- 最後活動時間

**用途**：
- 異常登入偵測
- 多裝置管理
- 安全審計

---

### 4. Token 安全

**JWT Secret**：
- 儲存在環境變數 `JWT_SECRET`
- 使用強隨機字串

**Token 過期**：
- JWT Token：24 小時
- Refresh Token：7 天
- 定期清理過期 Session

**防護機制**：
- Token 簽章驗證
- 過期時間檢查
- 黑名單機制（登出時使 Token 失效）

---

### 5. 軟刪除

**機制**：
- 使用者刪除時不從資料庫移除
- 設定 `deleted_at` 時間戳記
- 查詢時自動過濾已刪除資料

**好處**：
- 資料可恢復
- 保留審計軌跡
- 避免外鍵錯誤

---

### 6. SQL Injection 防護

**使用 Query Builder**：
```php
// ✓ 安全
$this->where('username', $username)->first();

// ✗ 不安全
$this->query("SELECT * FROM users WHERE username = '$username'");
```

**參數化查詢**：
```php
$this->query(
    "SELECT * FROM users WHERE username = ? AND role = ?",
    [$username, $role]
);
```

---

### 7. XSS 防護

**前端**：
- Vue 自動跳脫變數
- 避免使用 `v-html`
- 輸入驗證

**後端**：
- 使用 CodeIgniter 的 `esc()` 函數
- HTML 特殊字元轉義

---

## 檔案路徑參考

### 後端檔案

#### Migrations
```
backend/app/Database/Migrations/
├── 2025-01-01-000010_CreateUserAuthenticationTables.php
├── 2025-10-26-000001_AddUserTypeFieldsToUsersTable.php
└── 2025-11-01-114445_AddUserProfileFieldsToUsersTable.php
```

#### Models
```
backend/app/Models/
├── UserModel.php
└── UserSessionModel.php
```

#### Controllers
```
backend/app/Controllers/Api/
├── AuthController.php
└── UserController.php
```

#### Helpers
```
backend/app/Helpers/
└── auth_helper.php
```

#### Filters
```
backend/app/Filters/
└── JWTAuthFilter.php
```

---

### 前端檔案

#### Pages
```
frontend/pages/
├── login.vue
├── signup.vue
└── pages/
    └── user.vue
```

#### Stores
```
frontend/stores/
└── auth.js
```

#### Composables
```
frontend/composables/
├── useAuth.js
└── useUsers.js
```

#### Middleware
```
frontend/middleware/
├── auth.js
├── guest.js
└── role.js
```

---

## 開發建議

### 1. 新增角色

修改以下檔案：
1. Migration：新增角色到 `role` ENUM
2. 前端：更新 `middleware/role.js` 的角色列表
3. 後端：更新權限檢查邏輯

### 2. 新增權限類型

1. 在 `user_permissions` 表格新增權限類型
2. 在 `auth_helper.php` 新增對應的檢查函數
3. 在相關 Controller 使用權限檢查

### 3. 自訂 Token 過期時間

修改 `backend/app/Helpers/auth_helper.php`：
```php
// JWT Token 過期時間（秒）
$expiresAt = time() + (24 * 60 * 60); // 24小時

// Refresh Token 過期時間（秒）
$refreshExpiresAt = time() + (7 * 24 * 60 * 60); // 7天
```

### 4. 新增使用者欄位

1. 建立新的 Migration
2. 更新 `UserModel.php` 的 `$allowedFields`
3. 更新前端表單和驗證邏輯

---

## 常見問題

### Q1: 如何重設管理員密碼？

直接在資料庫執行：
```sql
UPDATE users
SET password_hash = '$2y$10$...' -- 使用 password_hash('新密碼', PASSWORD_DEFAULT) 產生
WHERE id = 1;
```

### Q2: 使用者帳號被鎖定怎麼辦？

方法 1：等待 30 分鐘自動解鎖

方法 2：管理員手動解鎖
- 呼叫 `PATCH /api/users/{id}/reset-login-attempts`

方法 3：資料庫直接解鎖
```sql
UPDATE users
SET login_attempts = 0, locked_until = NULL
WHERE id = {user_id};
```

### Q3: Token 過期如何處理？

前端會自動使用 Refresh Token 更新，無需手動處理。

如果 Refresh Token 也過期，使用者需要重新登入。

### Q4: 如何檢查使用者是否有特定權限？

後端：
```php
if (!auth_check_permission('meeting_manage')) {
    return $this->failUnauthorized();
}
```

前端：
```javascript
const authStore = useAuthStore()
if (authStore.user.role === 'admin') {
  // 執行管理員操作
}
```

### Q5: 如何實作「記住我」功能？

1. 延長 Refresh Token 有效期
2. 在 localStorage 儲存 Token
3. 應用啟動時自動檢查並刷新 Token

---

## 更新日誌

### 2025-11-01
- 新增使用者個人資料欄位：`nickname`、`line_account`、`position`
- 更新文檔架構

### 2025-10-26
- 新增企業使用者功能
- 新增 `user_type` 和 `is_company_manager` 欄位

### 2025-01-01
- 初始會員系統建立
- 實作 JWT 認證
- 建立角色權限系統

---

## 結語

本會員系統提供完整的使用者管理、認證授權、角色權限控制等功能，適用於需要多角色管理的應用系統。如有任何問題或建議，歡迎提出。