# Excel 匯出功能測試清單

## 測試目的
確保所有 Excel 匯出功能：
1. 正常運作，無錯誤
2. 中文字元顯示正確，無亂碼
3. 檔案格式正確（XLSX）
4. 權限控制正確

## 測試環境要求
- PHP 環境已安裝 PhpSpreadsheet 套件
- 資料庫中有測試資料
- 具有適當權限的測試帳號（admin、chairman、member）

## 1. 會議簽到記錄匯出測試

**測試路徑：** `POST /api/meetings/{meetingId}/attendances/export`

**前置條件：**
- 需要有一場會議記錄（meeting_id）
- 該會議需要有簽到記錄資料
- 測試帳號需要有 admin 或 chairman 權限

**測試步驟：**
1. 登入系統（使用 admin 或 chairman 帳號）
2. 前往會議簽到頁面：`/tables/meeting/{meetingId}/member-checkin`
3. 點擊「匯出簽到結果」按鈕
4. 下載產生的 XLSX 檔案

**驗證重點：**
- [ ] 檔案能正常下載
- [ ] 檔案格式為 `.xlsx`
- [ ] 檔案名稱格式：`會員報到結果_{會議名稱}_{時間戳}.xlsx`
- [ ] 使用 Excel 或 LibreOffice 開啟檔案
- [ ] 確認中文字元顯示正確（標題、會議名稱、會員姓名等）
- [ ] 確認統計數據正確（親自出席、代理出席、未出席人數）
- [ ] 確認詳細簽到記錄完整
- [ ] 表格格式正確（標頭加粗、有邊框、有背景色）

**測試資料位置：**
```
backend/app/Controllers/Api/MeetingAttendanceController.php:371-451
backend/app/Controllers/Api/MeetingAttendanceController.php:576-739
```

---

## 2. 所有權人資料匯出測試

**測試路徑：** `GET /api/urban-renewals/{urbanRenewalId}/property-owners/export`

**前置條件：**
- 需要有都更案資料（urban_renewal_id）
- 該都更案需要有所有權人資料
- 測試帳號需要有對應權限

**測試步驟：**
1. 登入系統
2. 前往所有權人管理頁面：`/tables/urban-renewal/{id}/property-owners`
3. 點擊「匯出所有權人資料」按鈕
4. 下載產生的 XLSX 檔案

**驗證重點：**
- [ ] 檔案能正常下載
- [ ] 檔案格式為 `.xlsx`
- [ ] 檔案名稱格式：`所有權人_{都更案名稱}_{日期}.xlsx`
- [ ] 使用 Excel 或 LibreOffice 開啟檔案
- [ ] 確認中文字元顯示正確（所有權人姓名、地址等）
- [ ] 確認所有欄位資料完整：
  - 所有權人編號
  - 所有權人名稱
  - 身分證字號
  - 電話1、電話2
  - 聯絡地址、戶籍地址
  - 排除類型
  - 備註
- [ ] 表格格式正確（標頭加粗、有背景色）
- [ ] 欄寬自動調整適當

**測試資料位置：**
```
backend/app/Controllers/Api/PropertyOwnerController.php:537-631
```

---

## 3. 所有權人匯入範本下載測試

**測試路徑：** `GET /api/property-owners/template`

**前置條件：**
- 無特殊前置條件

**測試步驟：**
1. 登入系統
2. 前往所有權人管理頁面：`/tables/urban-renewal/{id}/property-owners`
3. 點擊「匯入所有權人」按鈕
4. 在彈出的對話框中，點擊「下載範本」
5. 下載產生的 XLSX 檔案

**驗證重點：**
- [ ] 檔案能正常下載
- [ ] 檔案格式為 `.xlsx`
- [ ] 檔案名稱格式：`所有權人匯入範本_{日期}.xlsx`
- [ ] 使用 Excel 或 LibreOffice 開啟檔案
- [ ] 確認標頭列中文顯示正確
- [ ] 確認有範例資料列
- [ ] 確認範例資料中的中文顯示正確
- [ ] 範例資料備註欄顯示「此列不會被匯入」
- [ ] 表格格式正確（標頭加粗、有背景色）

**測試資料位置：**
```
backend/app/Controllers/Api/PropertyOwnerController.php:636-710
```

---

## 4. 投票記錄匯出測試（新增功能）

**測試路徑：** `GET /api/voting/export/{topicId}`

**前置條件：**
- 需要有投票議題資料（voting_topic_id）
- 該議題需要有投票記錄
- 測試帳號需要有 admin 或 chairman 權限

**測試步驟：**
1. 登入系統（使用 admin 或 chairman 帳號）
2. 建立或找到一個有投票記錄的議題
3. 使用 API 測試工具或前端頁面（待實作）呼叫匯出 API
4. 下載產生的 XLSX 檔案

**API 測試範例：**
```bash
# 使用 curl 測試（需要先取得 token）
curl -X GET "http://localhost/api/voting/export/1" \
  -H "Authorization: Bearer YOUR_TOKEN" \
  -o voting_records.xlsx
```

**驗證重點：**
- [ ] 檔案能正常下載
- [ ] 檔案格式為 `.xlsx`
- [ ] 檔案名稱格式：`投票記錄_{topicId}_{時間戳}.xlsx`
- [ ] 使用 Excel 或 LibreOffice 開啟檔案
- [ ] 確認主標題「投票記錄報表」中文顯示正確
- [ ] 確認議題資訊區塊：
  - 議題名稱
  - 議題說明
  - 會議名稱
- [ ] 確認投票統計區塊：
  - 同意、不同意、棄權的票數
  - 土地面積權重
  - 建物面積權重
  - 總計列加粗顯示
- [ ] 確認詳細投票記錄：
  - 投票時間
  - 所有權人姓名（中文正確）
  - 身分證字號
  - 投票選擇（同意/不同意/棄權，中文正確）
  - 土地面積權重
  - 建物面積權重
  - 備註
- [ ] 所有中文字元顯示正確，無亂碼
- [ ] 表格格式正確（標頭加粗、有邊框、有背景色）
- [ ] 數字格式正確（權重顯示兩位小數）

**測試資料位置：**
```
backend/app/Controllers/Api/VotingController.php:327-392
backend/app/Controllers/Api/VotingController.php:436-587
```

---

## 編碼測試重點

針對所有匯出功能，特別測試以下中文字元是否正確顯示：

### 常見中文字元測試
- [ ] 繁體中文常用字：會議、簽到、所有權人、投票
- [ ] 人名：王小明、李大華、陳美玲
- [ ] 地址：台北市、新北市、桃園市
- [ ] 特殊中文字元：鑫、淼、焱、森

### Unicode 特殊字元測試
- [ ] 全形符號：（）、【】、「」
- [ ] 中文數字：一、二、三、十
- [ ] 注音符號：ㄅ、ㄆ、ㄇ

## 權限測試

確認權限控制正確：

### 會議簽到記錄匯出
- [ ] Admin 可以匯出任何會議的簽到記錄
- [ ] Chairman 只能匯出自己都更案的會議簽到記錄
- [ ] Member 不能匯出（應該回傳 403 錯誤）
- [ ] 未登入使用者不能匯出（應該回傳 401 錯誤）

### 投票記錄匯出
- [ ] Admin 可以匯出任何議題的投票記錄
- [ ] Chairman 只能匯出自己都更案的投票記錄
- [ ] 其他角色不能匯出（應該回傳 403 錯誤）
- [ ] 未登入使用者不能匯出（應該回傳 401 錯誤）

### 所有權人匯出
- [ ] 有適當權限的使用者可以匯出
- [ ] 無權限使用者不能匯出

## 效能測試

### 大量資料測試
- [ ] 測試匯出 100 筆所有權人資料
- [ ] 測試匯出 500 筆投票記錄
- [ ] 測試匯出 1000 筆會議簽到記錄
- [ ] 確認匯出時間在可接受範圍內（< 10 秒）
- [ ] 確認不會發生記憶體溢位錯誤

## 相容性測試

確認匯出的 Excel 檔案可在以下軟體正常開啟：

- [ ] Microsoft Excel 2016 或更新版本
- [ ] LibreOffice Calc
- [ ] Google Sheets（上傳後開啟）
- [ ] WPS Office

## 錯誤處理測試

### 會議簽到記錄
- [ ] 不存在的會議 ID → 回傳 404 錯誤
- [ ] 無簽到記錄的會議 → 產生空報表或適當提示

### 投票記錄
- [ ] 不存在的議題 ID → 回傳 404 錯誤
- [ ] 無投票記錄的議題 → 產生空報表或適當提示

### 所有權人
- [ ] 不存在的都更案 ID → 回傳 404 錯誤
- [ ] 無所有權人的都更案 → 回傳錯誤訊息

## 檔案系統測試

- [ ] 確認 `backend/writable/exports/` 目錄存在
- [ ] 確認目錄有寫入權限（755）
- [ ] 確認匯出的檔案正確儲存
- [ ] 確認舊檔案有自動清理機制（如有實作）

## 回歸測試清單

每次修改匯出功能後，都應執行以下快速測試：

1. [ ] 會議簽到記錄匯出 - 中文顯示正確
2. [ ] 所有權人匯出 - 中文顯示正確
3. [ ] 投票記錄匯出 - 中文顯示正確
4. [ ] 檔案可正常開啟
5. [ ] 權限控制正確

## 已知問題與限制

### 目前狀況
- 投票記錄匯出功能已實作，但前端頁面尚未整合匯出按鈕
- 所有匯出功能都已轉為後端 XLSX 格式
- PhpSpreadsheet 套件已安裝並可正常使用

### 建議改進
1. 為投票記錄匯出新增前端頁面整合
2. 考慮新增定時清理舊匯出檔案的機制
3. 考慮使用 ExcelExportService 重構現有匯出功能

## 測試完成簽核

- 測試人員：________________
- 測試日期：________________
- 測試結果：[ ] 通過  [ ] 失敗  [ ] 部分通過
- 問題描述：________________
