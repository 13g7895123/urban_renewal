openapi: 3.0.3
info:
  title: 都更計票系統 - 會議 API
  description: |
    會議管理相關 API，包含會議的 CRUD 操作、會議狀態管理、會員報到等功能。

    **主要功能**：
    - 會議基本資料管理
    - 會議狀態追蹤（草稿、已排程、進行中、已完成、已取消）
    - 會員報到管理（親自出席、委託出席、列席）
    - 報到統計和即時顯示
  version: 1.0.0

servers:
  - url: http://localhost:4002/api
    description: 開發環境

tags:
  - name: Meetings
    description: 會議管理
  - name: Attendance
    description: 會員報到管理

paths:
  # ============ 會議 API ============
  /meetings:
    get:
      tags:
        - Meetings
      summary: 取得會議列表
      description: |
        取得會議的分頁列表，支援多種篩選條件。

        **篩選條件**：
        - urban_renewal_id: 依都市更新會篩選
        - status: 依會議狀態篩選
        - search: 關鍵字搜尋會議名稱
      operationId: getMeetings
      security:
        - BearerAuth: []
      parameters:
        - $ref: './common.yaml#/components/parameters/PageParam'
        - $ref: './common.yaml#/components/parameters/PerPageParam'
        - name: urban_renewal_id
          in: query
          description: 都市更新會 ID
          required: false
          schema:
            type: integer
            example: 1
        - name: status
          in: query
          description: 會議狀態
          required: false
          schema:
            $ref: './common.yaml#/components/schemas/MeetingStatus'
        - $ref: './common.yaml#/components/parameters/SearchParam'
      responses:
        '200':
          description: 查詢成功
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                    example: true
                  data:
                    type: array
                    items:
                      $ref: '#/components/schemas/Meeting'
                  pagination:
                    $ref: './common.yaml#/components/schemas/Pagination'
                  message:
                    type: string
                    example: "取得會議列表成功"
        '401':
          $ref: './common.yaml#/components/responses/UnauthorizedError'
        '500':
          $ref: './common.yaml#/components/responses/InternalServerError'

    post:
      tags:
        - Meetings
      summary: 建立會議
      description: |
        建立新的會議。

        **必填欄位**：
        - urban_renewal_id: 都市更新會 ID
        - meeting_name: 會議名稱
        - meeting_type: 會議類型
        - meeting_date: 會議日期
        - meeting_time: 會議時間

        **注意事項**：
        - 系統會檢查同一更新會是否有時間衝突的會議
        - 新建立的會議預設狀態為 draft
      operationId: createMeeting
      security:
        - BearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/MeetingCreate'
            example:
              urban_renewal_id: 1
              meeting_name: "第一次會員大會"
              meeting_type: "會員大會"
              meeting_date: "2025-11-15"
              meeting_time: "14:00:00"
              meeting_location: "台北市大安區仁愛路四段 1 號 3 樓"
              land_area_numerator: 1
              land_area_denominator: 2
              building_area_numerator: 1
              building_area_denominator: 2
              owner_count_numerator: 1
              owner_count_denominator: 2
      responses:
        '201':
          description: 建立成功
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                    example: true
                  data:
                    $ref: '#/components/schemas/Meeting'
                  message:
                    type: string
                    example: "會議建立成功"
        '400':
          $ref: './common.yaml#/components/responses/BadRequestError'
        '401':
          $ref: './common.yaml#/components/responses/UnauthorizedError'
        '404':
          description: 都市更新會不存在
          content:
            application/json:
              schema:
                $ref: './common.yaml#/components/schemas/ErrorResponse'
        '422':
          description: 驗證錯誤或會議時間衝突
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                    example: false
                  error:
                    type: object
                    properties:
                      code:
                        type: string
                        example: "BUSINESS_LOGIC_ERROR"
                      message:
                        type: string
                        example: "該時間已有其他會議安排"
        '500':
          $ref: './common.yaml#/components/responses/InternalServerError'

  /meetings/{id}:
    get:
      tags:
        - Meetings
      summary: 取得會議詳情
      description: |
        取得指定會議的詳細資料，包含關聯的都市更新會資訊。
      operationId: getMeeting
      security:
        - BearerAuth: []
      parameters:
        - $ref: './common.yaml#/components/parameters/IDPathParam'
      responses:
        '200':
          description: 查詢成功
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                    example: true
                  data:
                    $ref: '#/components/schemas/MeetingDetail'
                  message:
                    type: string
                    example: "取得會議詳情成功"
        '401':
          $ref: './common.yaml#/components/responses/UnauthorizedError'
        '404':
          $ref: './common.yaml#/components/responses/NotFoundError'
        '500':
          $ref: './common.yaml#/components/responses/InternalServerError'

    put:
      tags:
        - Meetings
      summary: 更新會議資料
      description: |
        更新指定會議的資料。

        **注意事項**：
        - 如果更新日期或時間，系統會檢查是否有時間衝突
        - 可以更新的欄位包括會議名稱、類型、日期、時間、地點、法定人數設定等
      operationId: updateMeeting
      security:
        - BearerAuth: []
      parameters:
        - $ref: './common.yaml#/components/parameters/IDPathParam'
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/MeetingUpdate'
            example:
              meeting_name: "第一次會員大會（修訂）"
              meeting_location: "台北市大安區仁愛路四段 2 號 3 樓"
      responses:
        '200':
          description: 更新成功
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                    example: true
                  data:
                    $ref: '#/components/schemas/Meeting'
                  message:
                    type: string
                    example: "會議更新成功"
        '400':
          $ref: './common.yaml#/components/responses/BadRequestError'
        '401':
          $ref: './common.yaml#/components/responses/UnauthorizedError'
        '404':
          $ref: './common.yaml#/components/responses/NotFoundError'
        '422':
          description: 驗證錯誤或會議時間衝突
          content:
            application/json:
              schema:
                $ref: './common.yaml#/components/schemas/ValidationErrorResponse'
        '500':
          $ref: './common.yaml#/components/responses/InternalServerError'

    delete:
      tags:
        - Meetings
      summary: 刪除會議
      description: |
        刪除指定的會議（軟刪除）。

        **限制條件**：
        - 進行中或已完成的會議不能刪除
        - 有投票議題的會議需先刪除議題才能刪除會議
      operationId: deleteMeeting
      security:
        - BearerAuth: []
      parameters:
        - $ref: './common.yaml#/components/parameters/IDPathParam'
      responses:
        '200':
          description: 刪除成功
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                    example: true
                  message:
                    type: string
                    example: "會議刪除成功"
        '401':
          $ref: './common.yaml#/components/responses/UnauthorizedError'
        '404':
          $ref: './common.yaml#/components/responses/NotFoundError'
        '422':
          description: 業務邏輯錯誤（無法刪除）
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                    example: false
                  error:
                    type: object
                    properties:
                      code:
                        type: string
                        example: "BUSINESS_LOGIC_ERROR"
                      message:
                        type: string
                        example: "進行中或已完成的會議不能刪除"
        '500':
          $ref: './common.yaml#/components/responses/InternalServerError'

  /meetings/{id}/status:
    patch:
      tags:
        - Meetings
      summary: 更新會議狀態
      description: |
        更新會議的狀態。

        **狀態轉換規則**：
        - draft → scheduled, cancelled
        - scheduled → in_progress, cancelled
        - in_progress → completed, cancelled
        - completed → （無法變更）
        - cancelled → draft

        **注意事項**：
        - 不符合轉換規則的操作會被拒絕
        - 狀態變更會影響投票和報到功能
      operationId: updateMeetingStatus
      security:
        - BearerAuth: []
      parameters:
        - $ref: './common.yaml#/components/parameters/IDPathParam'
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - status
              properties:
                status:
                  $ref: './common.yaml#/components/schemas/MeetingStatus'
            example:
              status: "in_progress"
      responses:
        '200':
          description: 狀態更新成功
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                    example: true
                  data:
                    $ref: '#/components/schemas/Meeting'
                  message:
                    type: string
                    example: "會議狀態更新成功"
        '401':
          $ref: './common.yaml#/components/responses/UnauthorizedError'
        '404':
          $ref: './common.yaml#/components/responses/NotFoundError'
        '422':
          description: 狀態轉換不合法
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                    example: false
                  error:
                    type: object
                    properties:
                      code:
                        type: string
                        example: "BUSINESS_LOGIC_ERROR"
                      message:
                        type: string
                        example: "無法從狀態「completed」變更為「draft」"
        '500':
          $ref: './common.yaml#/components/responses/InternalServerError'

  /meetings/{id}/statistics:
    get:
      tags:
        - Meetings
      summary: 取得會議統計資料
      description: |
        取得指定會議的統計資料，包含：
        - 報到人數統計
        - 投票議題統計
        - 法定人數達成率
      operationId: getMeetingStatistics
      security:
        - BearerAuth: []
      parameters:
        - $ref: './common.yaml#/components/parameters/IDPathParam'
      responses:
        '200':
          description: 查詢成功
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                    example: true
                  data:
                    $ref: '#/components/schemas/MeetingStatistics'
                  message:
                    type: string
                    example: "取得會議統計成功"
        '401':
          $ref: './common.yaml#/components/responses/UnauthorizedError'
        '404':
          $ref: './common.yaml#/components/responses/NotFoundError'
        '500':
          $ref: './common.yaml#/components/responses/InternalServerError'

  # ============ 會員報到 API ============
  /meeting-attendance/check-in:
    post:
      tags:
        - Attendance
      summary: 會員報到（單筆）
      description: |
        為會員建立報到記錄。

        **報到類型**：
        - 親自出席：本人親自到場，計入法定人數
        - 委託出席：委託他人代理，需填寫受託人資訊，計入法定人數
        - 列席：參與會議但不計入法定人數
      operationId: checkIn
      security:
        - BearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/AttendanceCheckIn'
            examples:
              personal:
                summary: 親自出席
                value:
                  meeting_id: 1
                  property_owner_id: 10
                  attendance_type: "親自出席"
              proxy:
                summary: 委託出席
                value:
                  meeting_id: 1
                  property_owner_id: 11
                  attendance_type: "委託出席"
                  proxy_name: "李四"
                  proxy_phone: "0912-345-678"
                  proxy_id_number: "A123456789"
              observer:
                summary: 列席
                value:
                  meeting_id: 1
                  property_owner_id: 12
                  attendance_type: "列席"
      responses:
        '201':
          description: 報到成功
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                    example: true
                  data:
                    $ref: '#/components/schemas/Attendance'
                  message:
                    type: string
                    example: "報到成功"
        '400':
          $ref: './common.yaml#/components/responses/BadRequestError'
        '401':
          $ref: './common.yaml#/components/responses/UnauthorizedError'
        '422':
          $ref: './common.yaml#/components/responses/ValidationError'
        '500':
          $ref: './common.yaml#/components/responses/InternalServerError'

  /meeting-attendance/batch-check-in:
    post:
      tags:
        - Attendance
      summary: 批次報到
      description: |
        批次為多位會員建立報到記錄。

        **使用場景**：
        - 會議開始前預先登記多位出席者
        - 快速處理大量報到作業
      operationId: batchCheckIn
      security:
        - BearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - meeting_id
                - attendances
              properties:
                meeting_id:
                  type: integer
                  example: 1
                  description: 會議 ID
                attendances:
                  type: array
                  items:
                    type: object
                    required:
                      - property_owner_id
                      - attendance_type
                    properties:
                      property_owner_id:
                        type: integer
                        description: 所有權人 ID
                      attendance_type:
                        $ref: './common.yaml#/components/schemas/AttendanceType'
                      proxy_name:
                        type: string
                        description: 受託人姓名（委託出席時必填）
                      proxy_phone:
                        type: string
                        description: 受託人電話（委託出席時必填）
                      proxy_id_number:
                        type: string
                        description: 受託人身分證號（委託出席時必填）
            example:
              meeting_id: 1
              attendances:
                - property_owner_id: 10
                  attendance_type: "親自出席"
                - property_owner_id: 11
                  attendance_type: "親自出席"
                - property_owner_id: 12
                  attendance_type: "列席"
      responses:
        '201':
          description: 批次報到成功
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                    example: true
                  data:
                    type: object
                    properties:
                      total:
                        type: integer
                        example: 3
                        description: 總筆數
                      success:
                        type: integer
                        example: 3
                        description: 成功筆數
                      failed:
                        type: integer
                        example: 0
                        description: 失敗筆數
                  message:
                    type: string
                    example: "批次報到完成"
        '400':
          $ref: './common.yaml#/components/responses/BadRequestError'
        '401':
          $ref: './common.yaml#/components/responses/UnauthorizedError'
        '422':
          $ref: './common.yaml#/components/responses/ValidationError'
        '500':
          $ref: './common.yaml#/components/responses/InternalServerError'

  /meeting-attendance/{meetingId}/summary:
    get:
      tags:
        - Attendance
      summary: 取得報到摘要
      description: |
        取得指定會議的報到摘要統計。

        **統計項目**：
        - 出席人數（親自出席 + 委託出席）
        - 納入計算總人數
        - 列席總人數
        - 各類型報到人數分佈
      operationId: getAttendanceSummary
      security:
        - BearerAuth: []
      parameters:
        - name: meetingId
          in: path
          description: 會議 ID
          required: true
          schema:
            type: integer
      responses:
        '200':
          description: 查詢成功
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                    example: true
                  data:
                    $ref: '#/components/schemas/AttendanceSummary'
                  message:
                    type: string
                    example: "取得報到摘要成功"
        '401':
          $ref: './common.yaml#/components/responses/UnauthorizedError'
        '404':
          $ref: './common.yaml#/components/responses/NotFoundError'
        '500':
          $ref: './common.yaml#/components/responses/InternalServerError'

  /meeting-attendance/{meetingId}/export:
    get:
      tags:
        - Attendance
      summary: 匯出報到資料
      description: |
        匯出指定會議的報到資料為 Excel 檔案。

        **匯出欄位**：
        - 所有權人姓名
        - 身分證號
        - 報到類型
        - 報到時間
        - 受託人資訊（如適用）
      operationId: exportAttendance
      security:
        - BearerAuth: []
      parameters:
        - name: meetingId
          in: path
          description: 會議 ID
          required: true
          schema:
            type: integer
      responses:
        '200':
          description: 匯出成功
          content:
            application/vnd.openxmlformats-officedocument.spreadsheetml.sheet:
              schema:
                type: string
                format: binary
        '401':
          $ref: './common.yaml#/components/responses/UnauthorizedError'
        '404':
          $ref: './common.yaml#/components/responses/NotFoundError'
        '500':
          $ref: './common.yaml#/components/responses/InternalServerError'

components:
  securitySchemes:
    BearerAuth:
      type: http
      scheme: bearer
      bearerFormat: JWT

  schemas:
    Meeting:
      type: object
      properties:
        id:
          type: integer
          format: int64
          example: 1
        urban_renewal_id:
          type: integer
          example: 1
          description: 都市更新會 ID
        meeting_name:
          type: string
          example: "第一次會員大會"
          description: 會議名稱
        meeting_type:
          $ref: './common.yaml#/components/schemas/MeetingType'
        meeting_date:
          type: string
          format: date
          example: "2025-11-15"
          description: 會議日期
        meeting_time:
          type: string
          format: time
          example: "14:00:00"
          description: 會議時間
        meeting_location:
          type: string
          nullable: true
          example: "台北市大安區仁愛路四段 1 號 3 樓"
          description: 會議地點
        meeting_status:
          $ref: './common.yaml#/components/schemas/MeetingStatus'
        land_area_numerator:
          type: integer
          nullable: true
          example: 1
          description: 土地面積法定人數分子
        land_area_denominator:
          type: integer
          nullable: true
          example: 2
          description: 土地面積法定人數分母
        building_area_numerator:
          type: integer
          nullable: true
          example: 1
          description: 建物面積法定人數分子
        building_area_denominator:
          type: integer
          nullable: true
          example: 2
          description: 建物面積法定人數分母
        owner_count_numerator:
          type: integer
          nullable: true
          example: 1
          description: 所有權人數法定人數分子
        owner_count_denominator:
          type: integer
          nullable: true
          example: 2
          description: 所有權人數法定人數分母
        attendee_count:
          type: integer
          example: 80
          description: 出席人數
        calculated_total_count:
          type: integer
          example: 75
          description: 納入計算總人數
        observer_count:
          type: integer
          example: 5
          description: 列席總人數
        created_at:
          type: string
          format: date-time
        updated_at:
          type: string
          format: date-time
        deleted_at:
          type: string
          format: date-time
          nullable: true

    MeetingDetail:
      allOf:
        - $ref: '#/components/schemas/Meeting'
        - type: object
          properties:
            urban_renewal:
              type: object
              description: 關聯的都市更新會資訊
              properties:
                id:
                  type: integer
                name:
                  type: string
                area:
                  type: number
                member_count:
                  type: integer

    MeetingCreate:
      type: object
      required:
        - urban_renewal_id
        - meeting_name
        - meeting_type
        - meeting_date
        - meeting_time
      properties:
        urban_renewal_id:
          type: integer
          example: 1
        meeting_name:
          type: string
          maxLength: 255
          example: "第一次會員大會"
        meeting_type:
          $ref: './common.yaml#/components/schemas/MeetingType'
        meeting_date:
          type: string
          format: date
          example: "2025-11-15"
        meeting_time:
          type: string
          format: time
          example: "14:00:00"
        meeting_location:
          type: string
          maxLength: 500
          example: "台北市大安區仁愛路四段 1 號 3 樓"
        land_area_numerator:
          type: integer
          minimum: 0
          example: 1
        land_area_denominator:
          type: integer
          minimum: 1
          example: 2
        building_area_numerator:
          type: integer
          minimum: 0
          example: 1
        building_area_denominator:
          type: integer
          minimum: 1
          example: 2
        owner_count_numerator:
          type: integer
          minimum: 0
          example: 1
        owner_count_denominator:
          type: integer
          minimum: 1
          example: 2

    MeetingUpdate:
      type: object
      properties:
        meeting_name:
          type: string
          maxLength: 255
        meeting_type:
          $ref: './common.yaml#/components/schemas/MeetingType'
        meeting_date:
          type: string
          format: date
        meeting_time:
          type: string
          format: time
        meeting_location:
          type: string
          maxLength: 500
        meeting_status:
          $ref: './common.yaml#/components/schemas/MeetingStatus'
        land_area_numerator:
          type: integer
          minimum: 0
        land_area_denominator:
          type: integer
          minimum: 1
        building_area_numerator:
          type: integer
          minimum: 0
        building_area_denominator:
          type: integer
          minimum: 1
        owner_count_numerator:
          type: integer
          minimum: 0
        owner_count_denominator:
          type: integer
          minimum: 1

    MeetingStatistics:
      type: object
      properties:
        meeting_id:
          type: integer
          example: 1
        attendance:
          type: object
          properties:
            total_attendees:
              type: integer
              example: 80
              description: 總出席人數
            in_person:
              type: integer
              example: 70
              description: 親自出席人數
            by_proxy:
              type: integer
              example: 10
              description: 委託出席人數
            observers:
              type: integer
              example: 5
              description: 列席人數
            calculated_total:
              type: integer
              example: 75
              description: 納入計算總人數（親自出席 + 委託出席 - 列席）
        voting_topics:
          type: object
          properties:
            total:
              type: integer
              example: 5
              description: 議題總數
            draft:
              type: integer
              example: 1
              description: 草稿狀態議題數
            open:
              type: integer
              example: 2
              description: 投票中議題數
            closed:
              type: integer
              example: 2
              description: 已關閉議題數
        quorum:
          type: object
          description: 法定人數達成率
          properties:
            land_area_rate:
              type: number
              format: float
              example: 0.65
              description: 土地面積達成率（0-1）
            building_area_rate:
              type: number
              format: float
              example: 0.70
              description: 建物面積達成率（0-1）
            owner_count_rate:
              type: number
              format: float
              example: 0.75
              description: 所有權人數達成率（0-1）

    Attendance:
      type: object
      properties:
        id:
          type: integer
          format: int64
          example: 1
        meeting_id:
          type: integer
          example: 1
        property_owner_id:
          type: integer
          example: 10
        attendance_type:
          $ref: './common.yaml#/components/schemas/AttendanceType'
        checked_in_at:
          type: string
          format: date-time
          example: "2025-11-15T13:45:00Z"
          description: 報到時間
        proxy_name:
          type: string
          nullable: true
          example: "李四"
          description: 受託人姓名
        proxy_phone:
          type: string
          nullable: true
          example: "0912-345-678"
          description: 受託人電話
        proxy_id_number:
          type: string
          nullable: true
          example: "A123456789"
          description: 受託人身分證號
        created_at:
          type: string
          format: date-time
        updated_at:
          type: string
          format: date-time

    AttendanceCheckIn:
      type: object
      required:
        - meeting_id
        - property_owner_id
        - attendance_type
      properties:
        meeting_id:
          type: integer
          example: 1
        property_owner_id:
          type: integer
          example: 10
        attendance_type:
          $ref: './common.yaml#/components/schemas/AttendanceType'
        proxy_name:
          type: string
          maxLength: 100
          example: "李四"
          description: 受託人姓名（委託出席時必填）
        proxy_phone:
          type: string
          maxLength: 20
          example: "0912-345-678"
          description: 受託人電話（委託出席時必填）
        proxy_id_number:
          type: string
          maxLength: 20
          example: "A123456789"
          description: 受託人身分證號（委託出席時必填）

    AttendanceSummary:
      type: object
      properties:
        meeting_id:
          type: integer
          example: 1
        total_attendees:
          type: integer
          example: 80
          description: 總出席人數
        in_person_count:
          type: integer
          example: 70
          description: 親自出席人數
        by_proxy_count:
          type: integer
          example: 10
          description: 委託出席人數
        observer_count:
          type: integer
          example: 5
          description: 列席人數
        calculated_total:
          type: integer
          example: 75
          description: 納入計算總人數（親自出席 + 委託出席 - 列席）
        attendance_rate:
          type: number
          format: float
          example: 0.75
          description: 出席率（納入計算總人數 / 總所有權人數）
        by_type:
          type: array
          description: 各類型報到人數統計
          items:
            type: object
            properties:
              type:
                $ref: './common.yaml#/components/schemas/AttendanceType'
              count:
                type: integer
                example: 70
