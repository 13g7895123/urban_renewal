openapi: 3.0.3
info:
  title: 都更計票系統 - 會議管理 API
  version: 1.0.0
  description: |
    會議管理和會員報到的 API 規範
    
    **功能需求對應**:
    - FR-027 ~ FR-033: 會議管理
    - FR-034 ~ FR-042: 會員報到管理

servers:
  - url: http://localhost:4002/api
    description: 開發環境

paths:
  # ==================== 會議管理 ====================
  /meetings:
    get:
      summary: 取得會議列表
      description: 取得所有會議或特定都市更新會的會議列表
      operationId: listMeetings
      tags:
        - 會議管理
      security:
        - bearerAuth: []
      parameters:
        - name: urban_renewal_id
          in: query
          schema:
            type: integer
          description: 都市更新會 ID
        - name: status
          in: query
          schema:
            type: string
            enum: [draft, scheduled, in_progress, completed, cancelled]
          description: 會議狀態篩選
        - name: meeting_type
          in: query
          schema:
            type: string
            enum: [general_assembly, board_meeting, supervisory_meeting, extraordinary_meeting]
          description: 會議類型篩選
        - name: date_from
          in: query
          schema:
            type: string
            format: date
          description: 會議日期起始（YYYY-MM-DD）
        - name: date_to
          in: query
          schema:
            type: string
            format: date
          description: 會議日期結束（YYYY-MM-DD）
        - name: page
          in: query
          schema:
            type: integer
            default: 1
        - name: per_page
          in: query
          schema:
            type: integer
            default: 20
            maximum: 100
      responses:
        '200':
          description: 成功取得會議列表
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                    example: true
                  data:
                    type: array
                    items:
                      $ref: '#/components/schemas/Meeting'
                  pagination:
                    $ref: '#/components/schemas/Pagination'

    post:
      summary: 建立會議
      description: 建立新的會議
      operationId: createMeeting
      tags:
        - 會議管理
      security:
        - bearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - urban_renewal_id
                - title
                - meeting_type
                - meeting_date
                - meeting_time
              properties:
                urban_renewal_id:
                  type: integer
                  description: 都市更新會 ID
                  example: 1
                meeting_code:
                  type: string
                  description: 會議編號（選填，系統可自動生成）
                  example: MT202510001
                title:
                  type: string
                  description: 會議名稱
                  example: 第三次會員大會
                  minLength: 1
                  maxLength: 200
                meeting_type:
                  type: string
                  enum: [general_assembly, board_meeting, supervisory_meeting, extraordinary_meeting]
                  description: |
                    會議類型:
                    - general_assembly: 會員大會
                    - board_meeting: 理事會
                    - supervisory_meeting: 監事會
                    - extraordinary_meeting: 臨時會議
                  example: general_assembly
                meeting_date:
                  type: string
                  format: date
                  description: 會議日期
                  example: "2025-10-15"
                meeting_time:
                  type: string
                  format: time
                  description: 會議時間（HH:MM）
                  example: "14:00"
                location:
                  type: string
                  description: 會議地點
                  example: 台北市中正區市民大道一號
                description:
                  type: string
                  description: 會議說明
                quorum_land_numerator:
                  type: integer
                  description: 法定人數-土地面積分子
                  example: 1
                quorum_land_denominator:
                  type: integer
                  description: 法定人數-土地面積分母
                  example: 2
                quorum_building_numerator:
                  type: integer
                  description: 法定人數-建物面積分子
                  example: 1
                quorum_building_denominator:
                  type: integer
                  description: 法定人數-建物面積分母
                  example: 2
                quorum_owners_numerator:
                  type: integer
                  description: 法定人數-所有權人數分子
                  example: 1
                quorum_owners_denominator:
                  type: integer
                  description: 法定人數-所有權人數分母
                  example: 2
      responses:
        '201':
          description: 會議建立成功
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                    example: true
                  message:
                    type: string
                    example: 會議建立成功
                  data:
                    $ref: '#/components/schemas/Meeting'

  /meetings/{id}:
    get:
      summary: 取得單一會議
      description: 取得會議的詳細資訊
      operationId: getMeeting
      tags:
        - 會議管理
      security:
        - bearerAuth: []
      parameters:
        - $ref: '#/components/parameters/MeetingId'
      responses:
        '200':
          description: 成功取得會議資訊
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                    example: true
                  data:
                    $ref: '#/components/schemas/MeetingDetail'

    put:
      summary: 更新會議
      description: 更新會議資訊
      operationId: updateMeeting
      tags:
        - 會議管理
      security:
        - bearerAuth: []
      parameters:
        - $ref: '#/components/parameters/MeetingId'
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                title:
                  type: string
                meeting_type:
                  type: string
                  enum: [general_assembly, board_meeting, supervisory_meeting, extraordinary_meeting]
                meeting_date:
                  type: string
                  format: date
                meeting_time:
                  type: string
                  format: time
                location:
                  type: string
                description:
                  type: string
      responses:
        '200':
          description: 會議更新成功
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                    example: true
                  message:
                    type: string
                    example: 會議更新成功
                  data:
                    $ref: '#/components/schemas/Meeting'

    delete:
      summary: 刪除會議
      description: 刪除會議（軟刪除）
      operationId: deleteMeeting
      tags:
        - 會議管理
      security:
        - bearerAuth: []
      parameters:
        - $ref: '#/components/parameters/MeetingId'
      responses:
        '200':
          description: 會議刪除成功
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                    example: true
                  message:
                    type: string
                    example: 會議已刪除

  /meetings/{id}/status:
    patch:
      summary: 更新會議狀態
      description: 變更會議狀態
      operationId: updateMeetingStatus
      tags:
        - 會議管理
      security:
        - bearerAuth: []
      parameters:
        - $ref: '#/components/parameters/MeetingId'
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - status
              properties:
                status:
                  type: string
                  enum: [draft, scheduled, in_progress, completed, cancelled]
                  description: 新的會議狀態
      responses:
        '200':
          description: 狀態更新成功
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                    example: true
                  message:
                    type: string
                    example: 會議狀態已更新
                  data:
                    $ref: '#/components/schemas/Meeting'

  /meetings/{id}/statistics:
    get:
      summary: 取得會議統計
      description: 取得會議的統計資訊（報到、投票等）
      operationId: getMeetingStatistics
      tags:
        - 會議管理
      security:
        - bearerAuth: []
      parameters:
        - $ref: '#/components/parameters/MeetingId'
      responses:
        '200':
          description: 成功取得統計資訊
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                    example: true
                  data:
                    $ref: '#/components/schemas/MeetingStatistics'

  # ==================== 會員報到 ====================
  /meeting-attendance/check-in:
    post:
      summary: 單筆報到
      description: 為單一會員建立報到記錄
      operationId: checkIn
      tags:
        - 會員報到
      security:
        - bearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - meeting_id
                - property_owner_id
                - attendance_type
              properties:
                meeting_id:
                  type: integer
                  description: 會議 ID
                  example: 1
                property_owner_id:
                  type: integer
                  description: 所有權人 ID
                  example: 1
                attendance_type:
                  type: string
                  enum: [in_person, proxy, observer]
                  description: |
                    報到類型:
                    - in_person: 親自出席
                    - proxy: 委託出席
                    - observer: 列席
                  example: in_person
                proxy_name:
                  type: string
                  description: 受託人姓名（委託出席時必填）
                proxy_id_number:
                  type: string
                  description: 受託人身分證號
                proxy_relationship:
                  type: string
                  description: 受託人關係
                notes:
                  type: string
                  description: 備註
      responses:
        '201':
          description: 報到成功
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                    example: true
                  message:
                    type: string
                    example: 報到成功
                  data:
                    $ref: '#/components/schemas/Attendance'

  /meeting-attendance/batch-check-in:
    post:
      summary: 批次報到
      description: 為多位會員批次建立報到記錄
      operationId: batchCheckIn
      tags:
        - 會員報到
      security:
        - bearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - meeting_id
                - attendees
              properties:
                meeting_id:
                  type: integer
                  description: 會議 ID
                  example: 1
                attendees:
                  type: array
                  items:
                    type: object
                    required:
                      - property_owner_id
                      - attendance_type
                    properties:
                      property_owner_id:
                        type: integer
                      attendance_type:
                        type: string
                        enum: [in_person, proxy, observer]
                      proxy_name:
                        type: string
                      proxy_id_number:
                        type: string
      responses:
        '201':
          description: 批次報到成功
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                    example: true
                  message:
                    type: string
                    example: 批次報到成功
                  data:
                    type: object
                    properties:
                      total:
                        type: integer
                        example: 10
                      success_count:
                        type: integer
                        example: 10
                      failed_count:
                        type: integer
                        example: 0

  /meeting-attendance/{meetingId}/summary:
    get:
      summary: 取得報到摘要
      description: 取得會議的報到摘要統計
      operationId: getAttendanceSummary
      tags:
        - 會員報到
      security:
        - bearerAuth: []
      parameters:
        - name: meetingId
          in: path
          required: true
          schema:
            type: integer
          description: 會議 ID
      responses:
        '200':
          description: 成功取得報到摘要
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                    example: true
                  data:
                    $ref: '#/components/schemas/AttendanceSummary'

  /meeting-attendance/{meetingId}/list:
    get:
      summary: 取得報到列表
      description: 取得會議的詳細報到列表
      operationId: getAttendanceList
      tags:
        - 會員報到
      security:
        - bearerAuth: []
      parameters:
        - name: meetingId
          in: path
          required: true
          schema:
            type: integer
        - name: attendance_type
          in: query
          schema:
            type: string
            enum: [in_person, proxy, observer]
          description: 依報到類型篩選
        - name: page
          in: query
          schema:
            type: integer
            default: 1
        - name: per_page
          in: query
          schema:
            type: integer
            default: 50
      responses:
        '200':
          description: 成功取得報到列表
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                    example: true
                  data:
                    type: array
                    items:
                      $ref: '#/components/schemas/AttendanceDetail'
                  pagination:
                    $ref: '#/components/schemas/Pagination'

  /meeting-attendance/{id}/update-status:
    patch:
      summary: 更新報到狀態
      description: 修改已報到會員的報到類型
      operationId: updateAttendanceStatus
      tags:
        - 會員報到
      security:
        - bearerAuth: []
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: integer
          description: 報到記錄 ID
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - attendance_type
              properties:
                attendance_type:
                  type: string
                  enum: [in_person, proxy, observer]
                proxy_name:
                  type: string
                proxy_id_number:
                  type: string
      responses:
        '200':
          description: 報到狀態更新成功
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                    example: true
                  message:
                    type: string
                    example: 報到狀態已更新
                  data:
                    $ref: '#/components/schemas/Attendance'

components:
  schemas:
    Meeting:
      type: object
      properties:
        id:
          type: integer
          example: 1
        urban_renewal_id:
          type: integer
          example: 1
        meeting_code:
          type: string
          example: MT202510001
        title:
          type: string
          example: 第三次會員大會
        meeting_type:
          type: string
          enum: [general_assembly, board_meeting, supervisory_meeting, extraordinary_meeting]
          example: general_assembly
        meeting_date:
          type: string
          format: date
          example: "2025-10-15"
        meeting_time:
          type: string
          format: time
          example: "14:00"
        location:
          type: string
          example: 台北市中正區市民大道一號
        status:
          type: string
          enum: [draft, scheduled, in_progress, completed, cancelled]
          example: scheduled
        created_at:
          type: string
          format: date-time
        updated_at:
          type: string
          format: date-time

    MeetingDetail:
      allOf:
        - $ref: '#/components/schemas/Meeting'
        - type: object
          properties:
            description:
              type: string
            quorum_land_numerator:
              type: integer
            quorum_land_denominator:
              type: integer
            quorum_building_numerator:
              type: integer
            quorum_building_denominator:
              type: integer
            quorum_owners_numerator:
              type: integer
            quorum_owners_denominator:
              type: integer
            urban_renewal:
              type: object
              properties:
                id:
                  type: integer
                name:
                  type: string

    MeetingStatistics:
      type: object
      properties:
        meeting_id:
          type: integer
          example: 1
        total_property_owners:
          type: integer
          example: 100
          description: 總所有權人數
        attendance:
          type: object
          properties:
            total:
              type: integer
              example: 85
              description: 總報到人數
            in_person:
              type: integer
              example: 70
            proxy:
              type: integer
              example: 10
            observer:
              type: integer
              example: 5
            not_attended:
              type: integer
              example: 15
        quorum_status:
          type: object
          properties:
            is_met:
              type: boolean
              example: true
              description: 是否達到法定人數
            land_percentage:
              type: number
              format: decimal
              example: 52.5
            building_percentage:
              type: number
              format: decimal
              example: 55.3
            owners_percentage:
              type: number
              format: decimal
              example: 85.0
        voting_topics:
          type: object
          properties:
            total:
              type: integer
              example: 5
            draft:
              type: integer
              example: 1
            in_progress:
              type: integer
              example: 2
            closed:
              type: integer
              example: 2

    Attendance:
      type: object
      properties:
        id:
          type: integer
          example: 1
        meeting_id:
          type: integer
          example: 1
        property_owner_id:
          type: integer
          example: 1
        attendance_type:
          type: string
          enum: [in_person, proxy, observer]
          example: in_person
        proxy_name:
          type: string
          nullable: true
        proxy_id_number:
          type: string
          nullable: true
        proxy_relationship:
          type: string
          nullable: true
        check_in_time:
          type: string
          format: date-time
          example: "2025-10-15T14:05:30Z"
        notes:
          type: string
          nullable: true
        created_at:
          type: string
          format: date-time

    AttendanceDetail:
      allOf:
        - $ref: '#/components/schemas/Attendance'
        - type: object
          properties:
            property_owner:
              type: object
              properties:
                id:
                  type: integer
                name:
                  type: string
                owner_code:
                  type: string

    AttendanceSummary:
      type: object
      properties:
        meeting_id:
          type: integer
          example: 1
        total_property_owners:
          type: integer
          example: 100
        total_attended:
          type: integer
          example: 85
        in_person_count:
          type: integer
          example: 70
        proxy_count:
          type: integer
          example: 10
        observer_count:
          type: integer
          example: 5
        not_attended_count:
          type: integer
          example: 15
        attendance_percentage:
          type: number
          format: decimal
          example: 85.0
        included_in_quorum_count:
          type: integer
          example: 80
          description: 納入法定人數計算的人數（不含列席）

    Pagination:
      type: object
      properties:
        current_page:
          type: integer
        per_page:
          type: integer
        total:
          type: integer
        total_pages:
          type: integer

  parameters:
    MeetingId:
      name: id
      in: path
      required: true
      schema:
        type: integer
      description: 會議 ID

  securitySchemes:
    bearerAuth:
      type: http
      scheme: bearer
      bearerFormat: JWT

tags:
  - name: 會議管理
    description: 會議的建立、更新、刪除和狀態管理
  - name: 會員報到
    description: 會員報到功能，包含單筆和批次報到

