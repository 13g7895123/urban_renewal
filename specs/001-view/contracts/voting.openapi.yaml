openapi: 3.0.3
info:
  title: 都更計票系統 - 投票管理 API
  version: 1.0.0
  description: |
    投票議題管理和投票表決的 API 規範
    
    **功能需求對應**:
    - FR-043 ~ FR-048: 投票議題管理
    - FR-049 ~ FR-055: 投票表決管理
    - FR-056 ~ FR-061: 投票結果統計

servers:
  - url: http://localhost:4002/api
    description: 開發環境

paths:
  # ==================== 投票議題管理 ====================
  /voting-topics:
    get:
      summary: 取得投票議題列表
      description: 取得特定會議的所有投票議題
      operationId: listVotingTopics
      tags:
        - 投票議題
      security:
        - bearerAuth: []
      parameters:
        - name: meeting_id
          in: query
          required: true
          schema:
            type: integer
          description: 會議 ID
        - name: status
          in: query
          schema:
            type: string
            enum: [draft, in_progress, closed]
          description: 議題狀態篩選
        - name: page
          in: query
          schema:
            type: integer
            default: 1
          description: 頁碼
        - name: per_page
          in: query
          schema:
            type: integer
            default: 20
            maximum: 100
          description: 每頁筆數
      responses:
        '200':
          description: 成功取得議題列表
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                    example: true
                  data:
                    type: array
                    items:
                      $ref: '#/components/schemas/VotingTopic'
                  pagination:
                    $ref: '#/components/schemas/Pagination'
        '401':
          $ref: '#/components/responses/Unauthorized'

    post:
      summary: 建立投票議題
      description: 為會議建立新的投票議題
      operationId: createVotingTopic
      tags:
        - 投票議題
      security:
        - bearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - meeting_id
                - title
                - voting_method
              properties:
                meeting_id:
                  type: integer
                  description: 會議 ID
                  example: 1
                topic_code:
                  type: string
                  description: 議題編號（選填，系統可自動生成）
                  example: T1-001
                title:
                  type: string
                  description: 議題標題
                  example: 同意選任實施者案
                  minLength: 1
                  maxLength: 200
                description:
                  type: string
                  description: 議題說明
                  example: 本案經理事會討論，建議選任 XX 建設股份有限公司為實施者
                voting_method:
                  type: string
                  enum: [simple_majority, absolute_majority, two_thirds_majority, unanimous]
                  description: |
                    投票方式:
                    - simple_majority: 簡單多數（同意 > 不同意）
                    - absolute_majority: 絕對多數（同意 > 應出席 / 2）
                    - two_thirds_majority: 三分之二多數（同意 ≥ 應出席 * 2/3）
                    - unanimous: 全體一致（同意 = 應出席，不同意 = 0）
                  example: two_thirds_majority
                sort_order:
                  type: integer
                  description: 排序順序
                  example: 1
      responses:
        '201':
          description: 議題建立成功
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                    example: true
                  message:
                    type: string
                    example: 投票議題建立成功
                  data:
                    $ref: '#/components/schemas/VotingTopic'
        '400':
          $ref: '#/components/responses/BadRequest'
        '401':
          $ref: '#/components/responses/Unauthorized'

  /voting-topics/{id}:
    get:
      summary: 取得單一投票議題
      description: 取得投票議題的詳細資訊
      operationId: getVotingTopic
      tags:
        - 投票議題
      security:
        - bearerAuth: []
      parameters:
        - $ref: '#/components/parameters/TopicId'
      responses:
        '200':
          description: 成功取得議題資訊
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                    example: true
                  data:
                    $ref: '#/components/schemas/VotingTopic'
        '404':
          $ref: '#/components/responses/NotFound'

    put:
      summary: 更新投票議題
      description: 更新投票議題資訊（僅限草稿狀態）
      operationId: updateVotingTopic
      tags:
        - 投票議題
      security:
        - bearerAuth: []
      parameters:
        - $ref: '#/components/parameters/TopicId'
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                title:
                  type: string
                  minLength: 1
                  maxLength: 200
                description:
                  type: string
                voting_method:
                  type: string
                  enum: [simple_majority, absolute_majority, two_thirds_majority, unanimous]
                sort_order:
                  type: integer
      responses:
        '200':
          description: 議題更新成功
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                    example: true
                  message:
                    type: string
                    example: 投票議題更新成功
                  data:
                    $ref: '#/components/schemas/VotingTopic'
        '400':
          $ref: '#/components/responses/BadRequest'
        '404':
          $ref: '#/components/responses/NotFound'

    delete:
      summary: 刪除投票議題
      description: 刪除投票議題（軟刪除）
      operationId: deleteVotingTopic
      tags:
        - 投票議題
      security:
        - bearerAuth: []
      parameters:
        - $ref: '#/components/parameters/TopicId'
      responses:
        '200':
          description: 議題刪除成功
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                    example: true
                  message:
                    type: string
                    example: 投票議題已刪除
        '400':
          description: 無法刪除（議題已開始投票）
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '404':
          $ref: '#/components/responses/NotFound'

  /voting-topics/{id}/start:
    patch:
      summary: 開始投票
      description: 將議題狀態變更為「進行中」，允許會員投票
      operationId: startVoting
      tags:
        - 投票議題
      security:
        - bearerAuth: []
      parameters:
        - $ref: '#/components/parameters/TopicId'
      responses:
        '200':
          description: 投票已開始
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                    example: true
                  message:
                    type: string
                    example: 投票已開始
                  data:
                    $ref: '#/components/schemas/VotingTopic'
        '400':
          description: 無法開始投票（狀態不符）
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

  /voting-topics/{id}/close:
    patch:
      summary: 關閉投票
      description: 將議題狀態變更為「已關閉」，禁止投票和修改
      operationId: closeVoting
      tags:
        - 投票議題
      security:
        - bearerAuth: []
      parameters:
        - $ref: '#/components/parameters/TopicId'
      responses:
        '200':
          description: 投票已關閉
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                    example: true
                  message:
                    type: string
                    example: 投票已關閉
                  data:
                    $ref: '#/components/schemas/VotingTopicWithResults'
        '400':
          description: 無法關閉投票（狀態不符）
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

  # ==================== 投票表決 ====================
  /voting/vote:
    post:
      summary: 單筆投票
      description: 會員對單一議題進行投票
      operationId: vote
      tags:
        - 投票表決
      security:
        - bearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - voting_topic_id
                - property_owner_id
                - vote_choice
              properties:
                voting_topic_id:
                  type: integer
                  description: 投票議題 ID
                  example: 1
                property_owner_id:
                  type: integer
                  description: 所有權人 ID
                  example: 1
                vote_choice:
                  type: string
                  enum: [agree, disagree, abstain]
                  description: |
                    投票選擇:
                    - agree: 同意
                    - disagree: 不同意
                    - abstain: 棄權
                  example: agree
      responses:
        '201':
          description: 投票成功
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                    example: true
                  message:
                    type: string
                    example: 投票成功
                  data:
                    $ref: '#/components/schemas/VotingRecord'
        '400':
          description: 投票失敗（未報到、議題已關閉等）
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
              examples:
                not_checked_in:
                  value:
                    success: false
                    message: 投票失敗
                    errors:
                      - 該會員尚未報到，無法投票
                voting_closed:
                  value:
                    success: false
                    message: 投票失敗
                    errors:
                      - 該議題投票已關閉

  /voting/batch-vote:
    post:
      summary: 批次投票
      description: 會員對多個議題進行批次投票（相同選擇）
      operationId: batchVote
      tags:
        - 投票表決
      security:
        - bearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - voting_topic_ids
                - property_owner_id
                - vote_choice
              properties:
                voting_topic_ids:
                  type: array
                  items:
                    type: integer
                  description: 投票議題 ID 陣列
                  example: [1, 2, 3]
                property_owner_id:
                  type: integer
                  description: 所有權人 ID
                  example: 1
                vote_choice:
                  type: string
                  enum: [agree, disagree, abstain]
                  description: 投票選擇（對所有議題）
                  example: agree
      responses:
        '201':
          description: 批次投票成功
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                    example: true
                  message:
                    type: string
                    example: 批次投票成功
                  data:
                    type: object
                    properties:
                      total:
                        type: integer
                        example: 3
                        description: 總投票數
                      success_count:
                        type: integer
                        example: 3
                        description: 成功投票數
                      failed_count:
                        type: integer
                        example: 0
                        description: 失敗投票數
                      records:
                        type: array
                        items:
                          $ref: '#/components/schemas/VotingRecord'

  /voting/my-vote/{topicId}:
    get:
      summary: 取得我的投票記錄
      description: 取得當前使用者在特定議題的投票記錄
      operationId: getMyVote
      tags:
        - 投票表決
      security:
        - bearerAuth: []
      parameters:
        - name: topicId
          in: path
          required: true
          schema:
            type: integer
          description: 投票議題 ID
        - name: property_owner_id
          in: query
          required: true
          schema:
            type: integer
          description: 所有權人 ID
      responses:
        '200':
          description: 成功取得投票記錄
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                    example: true
                  data:
                    $ref: '#/components/schemas/VotingRecord'
        '404':
          description: 尚未投票
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

  # ==================== 投票統計 ====================
  /voting/statistics/{topicId}:
    get:
      summary: 取得投票統計
      description: 取得特定議題的投票統計結果
      operationId: getVotingStatistics
      tags:
        - 投票統計
      security:
        - bearerAuth: []
      parameters:
        - name: topicId
          in: path
          required: true
          schema:
            type: integer
          description: 投票議題 ID
      responses:
        '200':
          description: 成功取得統計結果
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                    example: true
                  data:
                    $ref: '#/components/schemas/VotingStatistics'
        '404':
          $ref: '#/components/responses/NotFound'

  /voting/detailed/{topicId}:
    get:
      summary: 取得詳細投票記錄
      description: 取得特定議題的所有投票記錄（包含個別會員投票）
      operationId: getDetailedVoting
      tags:
        - 投票統計
      security:
        - bearerAuth: []
      parameters:
        - name: topicId
          in: path
          required: true
          schema:
            type: integer
          description: 投票議題 ID
        - name: vote_choice
          in: query
          schema:
            type: string
            enum: [agree, disagree, abstain]
          description: 依投票選擇篩選
        - name: page
          in: query
          schema:
            type: integer
            default: 1
        - name: per_page
          in: query
          schema:
            type: integer
            default: 50
            maximum: 100
      responses:
        '200':
          description: 成功取得詳細記錄
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                    example: true
                  data:
                    type: array
                    items:
                      $ref: '#/components/schemas/DetailedVotingRecord'
                  pagination:
                    $ref: '#/components/schemas/Pagination'

  /voting/export/{topicId}:
    get:
      summary: 匯出投票結果
      description: 匯出投票結果為 Excel 或 PDF 格式
      operationId: exportVoting
      tags:
        - 投票統計
      security:
        - bearerAuth: []
      parameters:
        - name: topicId
          in: path
          required: true
          schema:
            type: integer
          description: 投票議題 ID
        - name: format
          in: query
          schema:
            type: string
            enum: [excel, pdf]
            default: excel
          description: 匯出格式
      responses:
        '200':
          description: 成功匯出
          content:
            application/vnd.openxmlformats-officedocument.spreadsheetml.sheet:
              schema:
                type: string
                format: binary
            application/pdf:
              schema:
                type: string
                format: binary
        '404':
          $ref: '#/components/responses/NotFound'

components:
  schemas:
    VotingTopic:
      type: object
      properties:
        id:
          type: integer
          example: 1
          description: 議題 ID
        meeting_id:
          type: integer
          example: 1
          description: 會議 ID
        topic_code:
          type: string
          example: T1-001
          description: 議題編號
        title:
          type: string
          example: 同意選任實施者案
          description: 議題標題
        description:
          type: string
          example: 本案經理事會討論，建議選任 XX 建設股份有限公司為實施者
          description: 議題說明
        voting_method:
          type: string
          enum: [simple_majority, absolute_majority, two_thirds_majority, unanimous]
          example: two_thirds_majority
          description: 投票方式
        status:
          type: string
          enum: [draft, in_progress, closed]
          example: in_progress
          description: 投票狀態
        sort_order:
          type: integer
          example: 1
          description: 排序順序
        started_at:
          type: string
          format: date-time
          nullable: true
          description: 投票開始時間
        closed_at:
          type: string
          format: date-time
          nullable: true
          description: 投票結束時間
        created_at:
          type: string
          format: date-time
          description: 建立時間
        updated_at:
          type: string
          format: date-time
          description: 更新時間

    VotingTopicWithResults:
      allOf:
        - $ref: '#/components/schemas/VotingTopic'
        - type: object
          properties:
            results:
              $ref: '#/components/schemas/VotingStatistics'

    VotingRecord:
      type: object
      properties:
        id:
          type: integer
          example: 1
          description: 投票記錄 ID
        voting_topic_id:
          type: integer
          example: 1
          description: 投票議題 ID
        property_owner_id:
          type: integer
          example: 1
          description: 所有權人 ID
        vote_choice:
          type: string
          enum: [agree, disagree, abstain]
          example: agree
          description: 投票選擇
        land_area_weight:
          type: number
          format: decimal
          example: 120.50
          description: 土地面積權重
        building_area_weight:
          type: number
          format: decimal
          example: 80.30
          description: 建物面積權重
        voted_at:
          type: string
          format: date-time
          description: 投票時間

    DetailedVotingRecord:
      allOf:
        - $ref: '#/components/schemas/VotingRecord'
        - type: object
          properties:
            property_owner:
              type: object
              properties:
                id:
                  type: integer
                name:
                  type: string
                owner_code:
                  type: string

    VotingStatistics:
      type: object
      properties:
        topic_id:
          type: integer
          example: 1
          description: 議題 ID
        voting_method:
          type: string
          example: two_thirds_majority
          description: 投票方式
        total_voters:
          type: integer
          example: 100
          description: 總投票人數
        total_attendance:
          type: integer
          example: 85
          description: 實際出席人數（納入計算）
        vote_count:
          type: object
          properties:
            agree:
              type: integer
              example: 70
            disagree:
              type: integer
              example: 10
            abstain:
              type: integer
              example: 5
            not_voted:
              type: integer
              example: 15
          description: 票數統計（人數）
        land_area:
          type: object
          properties:
            agree:
              type: number
              format: decimal
              example: 8500.50
            disagree:
              type: number
              format: decimal
              example: 1200.30
            abstain:
              type: number
              format: decimal
              example: 300.20
            total:
              type: number
              format: decimal
              example: 10000.00
          description: 土地面積統計（平方公尺）
        building_area:
          type: object
          properties:
            agree:
              type: number
              format: decimal
              example: 6700.80
            disagree:
              type: number
              format: decimal
              example: 950.20
            abstain:
              type: number
              format: decimal
              example: 200.00
            total:
              type: number
              format: decimal
              example: 7850.00
          description: 建物面積統計（平方公尺）
        percentage:
          type: object
          properties:
            agree:
              type: number
              format: decimal
              example: 82.35
            disagree:
              type: number
              format: decimal
              example: 11.76
            abstain:
              type: number
              format: decimal
              example: 5.89
          description: 百分比統計
        result:
          type: object
          properties:
            passed:
              type: boolean
              example: true
              description: 是否通過
            status:
              type: string
              example: 三分之二多數通過
              description: 通過狀態說明
            required_percentage:
              type: number
              format: decimal
              example: 66.67
              description: 需要的通過百分比
            actual_percentage:
              type: number
              format: decimal
              example: 82.35
              description: 實際同意百分比

    Pagination:
      type: object
      properties:
        current_page:
          type: integer
          example: 1
        per_page:
          type: integer
          example: 20
        total:
          type: integer
          example: 100
        total_pages:
          type: integer
          example: 5

    Error:
      type: object
      properties:
        success:
          type: boolean
          example: false
        message:
          type: string
          example: 操作失敗
        errors:
          type: array
          items:
            type: string

  parameters:
    TopicId:
      name: id
      in: path
      required: true
      schema:
        type: integer
      description: 投票議題 ID

  responses:
    BadRequest:
      description: 請求參數錯誤
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/Error'
    
    Unauthorized:
      description: 未授權
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/Error'
    
    NotFound:
      description: 找不到資源
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/Error'

  securitySchemes:
    bearerAuth:
      type: http
      scheme: bearer
      bearerFormat: JWT

tags:
  - name: 投票議題
    description: 投票議題的建立、更新、刪除和狀態管理
  - name: 投票表決
    description: 會員投票功能，包含單筆和批次投票
  - name: 投票統計
    description: 投票結果統計和匯出功能

