openapi: 3.0.3
info:
  title: 都更計票系統 - 都市更新會 API
  description: |
    都市更新會管理相關 API，包含更新會的 CRUD 操作、所有權人管理、地籍資料管理等功能。

    **主要功能**：
    - 都市更新會基本資料管理
    - 所有權人資料管理（含批次匯入匯出）
    - 土地和建物資料管理
    - 地址階層式查詢（縣市、鄉鎮市區、地段）
  version: 1.0.0

servers:
  - url: http://localhost:4002/api
    description: 開發環境

tags:
  - name: Urban Renewals
    description: 都市更新會管理
  - name: Property Owners
    description: 所有權人管理
  - name: Land Plots
    description: 土地資料管理
  - name: Locations
    description: 地址階層資料

paths:
  # ============ 都市更新會 API ============
  /urban-renewals:
    get:
      tags:
        - Urban Renewals
      summary: 取得都市更新會列表
      description: |
        取得所有都市更新會的分頁列表，支援關鍵字搜尋。

        **篩選條件**：
        - 關鍵字搜尋更新會名稱
        - 分頁查詢
      operationId: getUrbanRenewals
      security:
        - BearerAuth: []
      parameters:
        - $ref: './common.yaml#/components/parameters/PageParam'
        - $ref: './common.yaml#/components/parameters/PerPageParam'
        - $ref: './common.yaml#/components/parameters/SearchParam'
      responses:
        '200':
          description: 查詢成功
          content:
            application/json:
              schema:
                type: object
                properties:
                  status:
                    type: string
                    example: "success"
                  message:
                    type: string
                    example: "查詢成功"
                  data:
                    type: array
                    items:
                      $ref: '#/components/schemas/UrbanRenewal'
                  pagination:
                    $ref: './common.yaml#/components/schemas/Pagination'
        '401':
          $ref: './common.yaml#/components/responses/UnauthorizedError'
        '500':
          $ref: './common.yaml#/components/responses/InternalServerError'

    post:
      tags:
        - Urban Renewals
      summary: 建立都市更新會
      description: |
        建立新的都市更新會。

        **必填欄位**：
        - name: 更新會名稱
        - area: 土地總面積
        - member_count: 所有權人總數
      operationId: createUrbanRenewal
      security:
        - BearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/UrbanRenewalCreate'
            example:
              name: "台北市大安區都市更新會"
              area: 5000.50
              member_count: 120
              chairman_name: "王大明"
              chairman_phone: "02-12345678"
              address: "台北市大安區仁愛路四段 1 號"
              representative: "張三"
      responses:
        '201':
          description: 建立成功
          content:
            application/json:
              schema:
                type: object
                properties:
                  status:
                    type: string
                    example: "success"
                  message:
                    type: string
                    example: "新增更新會成功"
                  data:
                    $ref: '#/components/schemas/UrbanRenewal'
        '400':
          $ref: './common.yaml#/components/responses/BadRequestError'
        '401':
          $ref: './common.yaml#/components/responses/UnauthorizedError'
        '422':
          $ref: './common.yaml#/components/responses/ValidationError'
        '500':
          $ref: './common.yaml#/components/responses/InternalServerError'

  /urban-renewals/{id}:
    get:
      tags:
        - Urban Renewals
      summary: 取得都市更新會詳情
      description: 取得指定都市更新會的詳細資料
      operationId: getUrbanRenewal
      security:
        - BearerAuth: []
      parameters:
        - $ref: './common.yaml#/components/parameters/IDPathParam'
      responses:
        '200':
          description: 查詢成功
          content:
            application/json:
              schema:
                type: object
                properties:
                  status:
                    type: string
                    example: "success"
                  message:
                    type: string
                    example: "查詢成功"
                  data:
                    $ref: '#/components/schemas/UrbanRenewal'
        '404':
          $ref: './common.yaml#/components/responses/NotFoundError'
        '401':
          $ref: './common.yaml#/components/responses/UnauthorizedError'
        '500':
          $ref: './common.yaml#/components/responses/InternalServerError'

    put:
      tags:
        - Urban Renewals
      summary: 更新都市更新會
      description: 更新指定都市更新會的資料
      operationId: updateUrbanRenewal
      security:
        - BearerAuth: []
      parameters:
        - $ref: './common.yaml#/components/parameters/IDPathParam'
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/UrbanRenewalUpdate'
            example:
              name: "台北市大安區都市更新會（更新）"
              chairman_phone: "02-87654321"
      responses:
        '200':
          description: 更新成功
          content:
            application/json:
              schema:
                type: object
                properties:
                  status:
                    type: string
                    example: "success"
                  message:
                    type: string
                    example: "更新成功"
                  data:
                    $ref: '#/components/schemas/UrbanRenewal'
        '400':
          $ref: './common.yaml#/components/responses/BadRequestError'
        '401':
          $ref: './common.yaml#/components/responses/UnauthorizedError'
        '404':
          $ref: './common.yaml#/components/responses/NotFoundError'
        '422':
          $ref: './common.yaml#/components/responses/ValidationError'
        '500':
          $ref: './common.yaml#/components/responses/InternalServerError'

    delete:
      tags:
        - Urban Renewals
      summary: 刪除都市更新會
      description: |
        刪除指定的都市更新會（軟刪除）。

        **注意事項**：
        - 如有關聯的會議資料，需先刪除會議才能刪除更新會
        - 執行軟刪除，資料不會真正從資料庫移除
      operationId: deleteUrbanRenewal
      security:
        - BearerAuth: []
      parameters:
        - $ref: './common.yaml#/components/parameters/IDPathParam'
      responses:
        '200':
          description: 刪除成功
          content:
            application/json:
              schema:
                type: object
                properties:
                  status:
                    type: string
                    example: "success"
                  message:
                    type: string
                    example: "刪除成功"
        '401':
          $ref: './common.yaml#/components/responses/UnauthorizedError'
        '404':
          $ref: './common.yaml#/components/responses/NotFoundError'
        '500':
          $ref: './common.yaml#/components/responses/InternalServerError'

  # ============ 所有權人 API ============
  /urban-renewals/{id}/property-owners:
    get:
      tags:
        - Property Owners
      summary: 取得都市更新會的所有權人列表
      description: 取得指定都市更新會下的所有權人分頁列表
      operationId: getPropertyOwnersByUrbanRenewal
      security:
        - BearerAuth: []
      parameters:
        - name: id
          in: path
          description: 都市更新會 ID
          required: true
          schema:
            type: integer
        - $ref: './common.yaml#/components/parameters/PageParam'
        - $ref: './common.yaml#/components/parameters/PerPageParam'
      responses:
        '200':
          description: 查詢成功
          content:
            application/json:
              schema:
                $ref: './common.yaml#/components/schemas/PaginatedResponse'
        '401':
          $ref: './common.yaml#/components/responses/UnauthorizedError'
        '404':
          $ref: './common.yaml#/components/responses/NotFoundError'
        '500':
          $ref: './common.yaml#/components/responses/InternalServerError'

  /urban-renewals/{id}/property-owners/import:
    post:
      tags:
        - Property Owners
      summary: 批次匯入所有權人
      description: |
        使用 Excel 檔案批次匯入所有權人資料。

        **檔案格式**：
        - 支援 .xlsx, .xls 格式
        - 第一行為欄位標題
        - 必要欄位：姓名、身分證號

        **欄位說明**：
        - 姓名
        - 身分證號
        - 聯絡電話
        - 行動電話
        - Email
        - 地址
        - 排除類型（選填）
      operationId: importPropertyOwners
      security:
        - BearerAuth: []
      parameters:
        - name: id
          in: path
          description: 都市更新會 ID
          required: true
          schema:
            type: integer
      requestBody:
        required: true
        content:
          multipart/form-data:
            schema:
              type: object
              required:
                - file
              properties:
                file:
                  type: string
                  format: binary
                  description: Excel 檔案
      responses:
        '200':
          description: 匯入成功
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                    example: true
                  data:
                    type: object
                    properties:
                      total:
                        type: integer
                        example: 100
                        description: 總筆數
                      success:
                        type: integer
                        example: 95
                        description: 成功筆數
                      failed:
                        type: integer
                        example: 5
                        description: 失敗筆數
                      errors:
                        type: array
                        description: 錯誤明細
                        items:
                          type: object
                          properties:
                            row:
                              type: integer
                              example: 10
                            message:
                              type: string
                              example: "身分證號格式錯誤"
                  message:
                    type: string
                    example: "匯入完成"
        '400':
          $ref: './common.yaml#/components/responses/BadRequestError'
        '401':
          $ref: './common.yaml#/components/responses/UnauthorizedError'
        '500':
          $ref: './common.yaml#/components/responses/InternalServerError'

  /urban-renewals/{id}/property-owners/export:
    get:
      tags:
        - Property Owners
      summary: 匯出所有權人資料
      description: |
        匯出指定都市更新會的所有權人資料為 Excel 檔案。

        **匯出欄位**：
        - 所有權人編號
        - 姓名
        - 身分證號
        - 聯絡電話
        - 行動電話
        - Email
        - 地址
        - 排除類型
        - 建立時間
      operationId: exportPropertyOwners
      security:
        - BearerAuth: []
      parameters:
        - name: id
          in: path
          description: 都市更新會 ID
          required: true
          schema:
            type: integer
      responses:
        '200':
          description: 匯出成功
          content:
            application/vnd.openxmlformats-officedocument.spreadsheetml.sheet:
              schema:
                type: string
                format: binary
        '401':
          $ref: './common.yaml#/components/responses/UnauthorizedError'
        '404':
          $ref: './common.yaml#/components/responses/NotFoundError'
        '500':
          $ref: './common.yaml#/components/responses/InternalServerError'

  /property-owners/template:
    get:
      tags:
        - Property Owners
      summary: 下載匯入範本
      description: 下載所有權人批次匯入的 Excel 範本檔案
      operationId: downloadPropertyOwnerTemplate
      security:
        - BearerAuth: []
      responses:
        '200':
          description: 下載成功
          content:
            application/vnd.openxmlformats-officedocument.spreadsheetml.sheet:
              schema:
                type: string
                format: binary
        '401':
          $ref: './common.yaml#/components/responses/UnauthorizedError'

  /property-owners/{id}:
    get:
      tags:
        - Property Owners
      summary: 取得所有權人詳情
      description: 取得指定所有權人的詳細資料
      operationId: getPropertyOwner
      security:
        - BearerAuth: []
      parameters:
        - $ref: './common.yaml#/components/parameters/IDPathParam'
      responses:
        '200':
          description: 查詢成功
          content:
            application/json:
              schema:
                $ref: './common.yaml#/components/schemas/SuccessResponse'
        '401':
          $ref: './common.yaml#/components/responses/UnauthorizedError'
        '404':
          $ref: './common.yaml#/components/responses/NotFoundError'
        '500':
          $ref: './common.yaml#/components/responses/InternalServerError'

    put:
      tags:
        - Property Owners
      summary: 更新所有權人
      description: 更新指定所有權人的資料
      operationId: updatePropertyOwner
      security:
        - BearerAuth: []
      parameters:
        - $ref: './common.yaml#/components/parameters/IDPathParam'
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/PropertyOwnerUpdate'
      responses:
        '200':
          description: 更新成功
          content:
            application/json:
              schema:
                $ref: './common.yaml#/components/schemas/SuccessResponse'
        '400':
          $ref: './common.yaml#/components/responses/BadRequestError'
        '401':
          $ref: './common.yaml#/components/responses/UnauthorizedError'
        '404':
          $ref: './common.yaml#/components/responses/NotFoundError'
        '422':
          $ref: './common.yaml#/components/responses/ValidationError'
        '500':
          $ref: './common.yaml#/components/responses/InternalServerError'

    delete:
      tags:
        - Property Owners
      summary: 刪除所有權人
      description: 刪除指定的所有權人（軟刪除）
      operationId: deletePropertyOwner
      security:
        - BearerAuth: []
      parameters:
        - $ref: './common.yaml#/components/parameters/IDPathParam'
      responses:
        '200':
          description: 刪除成功
          content:
            application/json:
              schema:
                $ref: './common.yaml#/components/schemas/SuccessResponse'
        '401':
          $ref: './common.yaml#/components/responses/UnauthorizedError'
        '404':
          $ref: './common.yaml#/components/responses/NotFoundError'
        '500':
          $ref: './common.yaml#/components/responses/InternalServerError'

  # ============ 土地資料 API ============
  /urban-renewals/{id}/land-plots:
    get:
      tags:
        - Land Plots
      summary: 取得都市更新會的土地列表
      description: 取得指定都市更新會下的土地資料列表
      operationId: getLandPlotsByUrbanRenewal
      security:
        - BearerAuth: []
      parameters:
        - name: id
          in: path
          description: 都市更新會 ID
          required: true
          schema:
            type: integer
        - $ref: './common.yaml#/components/parameters/PageParam'
        - $ref: './common.yaml#/components/parameters/PerPageParam'
      responses:
        '200':
          description: 查詢成功
          content:
            application/json:
              schema:
                $ref: './common.yaml#/components/schemas/PaginatedResponse'
        '401':
          $ref: './common.yaml#/components/responses/UnauthorizedError'
        '404':
          $ref: './common.yaml#/components/responses/NotFoundError'
        '500':
          $ref: './common.yaml#/components/responses/InternalServerError'

    post:
      tags:
        - Land Plots
      summary: 建立土地資料
      description: |
        為指定都市更新會建立土地資料。

        **必填欄位**：
        - county_code: 縣市代碼
        - district_code: 鄉鎮市區代碼
        - section_code: 地段代碼
        - land_number: 地號
        - area: 土地面積
      operationId: createLandPlot
      security:
        - BearerAuth: []
      parameters:
        - name: id
          in: path
          description: 都市更新會 ID
          required: true
          schema:
            type: integer
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/LandPlotCreate'
      responses:
        '201':
          description: 建立成功
          content:
            application/json:
              schema:
                $ref: './common.yaml#/components/schemas/SuccessResponse'
        '400':
          $ref: './common.yaml#/components/responses/BadRequestError'
        '401':
          $ref: './common.yaml#/components/responses/UnauthorizedError'
        '422':
          $ref: './common.yaml#/components/responses/ValidationError'
        '500':
          $ref: './common.yaml#/components/responses/InternalServerError'

  /land-plots/{id}:
    get:
      tags:
        - Land Plots
      summary: 取得土地資料詳情
      description: 取得指定土地的詳細資料
      operationId: getLandPlot
      security:
        - BearerAuth: []
      parameters:
        - $ref: './common.yaml#/components/parameters/IDPathParam'
      responses:
        '200':
          description: 查詢成功
          content:
            application/json:
              schema:
                $ref: './common.yaml#/components/schemas/SuccessResponse'
        '401':
          $ref: './common.yaml#/components/responses/UnauthorizedError'
        '404':
          $ref: './common.yaml#/components/responses/NotFoundError'
        '500':
          $ref: './common.yaml#/components/responses/InternalServerError'

    put:
      tags:
        - Land Plots
      summary: 更新土地資料
      description: 更新指定土地的資料
      operationId: updateLandPlot
      security:
        - BearerAuth: []
      parameters:
        - $ref: './common.yaml#/components/parameters/IDPathParam'
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/LandPlotUpdate'
      responses:
        '200':
          description: 更新成功
          content:
            application/json:
              schema:
                $ref: './common.yaml#/components/schemas/SuccessResponse'
        '400':
          $ref: './common.yaml#/components/responses/BadRequestError'
        '401':
          $ref: './common.yaml#/components/responses/UnauthorizedError'
        '404':
          $ref: './common.yaml#/components/responses/NotFoundError'
        '422':
          $ref: './common.yaml#/components/responses/ValidationError'
        '500':
          $ref: './common.yaml#/components/responses/InternalServerError'

    delete:
      tags:
        - Land Plots
      summary: 刪除土地資料
      description: 刪除指定的土地資料（軟刪除）
      operationId: deleteLandPlot
      security:
        - BearerAuth: []
      parameters:
        - $ref: './common.yaml#/components/parameters/IDPathParam'
      responses:
        '200':
          description: 刪除成功
          content:
            application/json:
              schema:
                $ref: './common.yaml#/components/schemas/SuccessResponse'
        '401':
          $ref: './common.yaml#/components/responses/UnauthorizedError'
        '404':
          $ref: './common.yaml#/components/responses/NotFoundError'
        '500':
          $ref: './common.yaml#/components/responses/InternalServerError'

  # ============ 地址階層資料 API ============
  /locations/counties:
    get:
      tags:
        - Locations
      summary: 取得縣市列表
      description: 取得台灣所有縣市的列表
      operationId: getCounties
      security:
        - BearerAuth: []
      responses:
        '200':
          description: 查詢成功
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                    example: true
                  data:
                    type: array
                    items:
                      $ref: '#/components/schemas/County'
                  message:
                    type: string
                    example: "取得縣市列表成功"
        '401':
          $ref: './common.yaml#/components/responses/UnauthorizedError'
        '500':
          $ref: './common.yaml#/components/responses/InternalServerError'

  /locations/districts/{countyCode}:
    get:
      tags:
        - Locations
      summary: 取得鄉鎮市區列表
      description: 取得指定縣市下的鄉鎮市區列表
      operationId: getDistricts
      security:
        - BearerAuth: []
      parameters:
        - name: countyCode
          in: path
          description: 縣市代碼
          required: true
          schema:
            type: string
            example: "A"
      responses:
        '200':
          description: 查詢成功
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                    example: true
                  data:
                    type: array
                    items:
                      $ref: '#/components/schemas/District'
                  message:
                    type: string
                    example: "取得鄉鎮市區列表成功"
        '401':
          $ref: './common.yaml#/components/responses/UnauthorizedError'
        '404':
          $ref: './common.yaml#/components/responses/NotFoundError'
        '500':
          $ref: './common.yaml#/components/responses/InternalServerError'

  /locations/sections/{countyCode}/{districtCode}:
    get:
      tags:
        - Locations
      summary: 取得地段列表
      description: 取得指定鄉鎮市區下的地段列表
      operationId: getSections
      security:
        - BearerAuth: []
      parameters:
        - name: countyCode
          in: path
          description: 縣市代碼
          required: true
          schema:
            type: string
            example: "A"
        - name: districtCode
          in: path
          description: 鄉鎮市區代碼
          required: true
          schema:
            type: string
            example: "01"
      responses:
        '200':
          description: 查詢成功
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                    example: true
                  data:
                    type: array
                    items:
                      $ref: '#/components/schemas/Section'
                  message:
                    type: string
                    example: "取得地段列表成功"
        '401':
          $ref: './common.yaml#/components/responses/UnauthorizedError'
        '404':
          $ref: './common.yaml#/components/responses/NotFoundError'
        '500':
          $ref: './common.yaml#/components/responses/InternalServerError'

components:
  securitySchemes:
    BearerAuth:
      type: http
      scheme: bearer
      bearerFormat: JWT

  schemas:
    UrbanRenewal:
      type: object
      properties:
        id:
          type: integer
          format: int64
          example: 1
        name:
          type: string
          example: "台北市大安區都市更新會"
          description: 更新會名稱
        area:
          type: number
          format: float
          example: 5000.50
          description: 土地總面積（平方公尺）
        member_count:
          type: integer
          example: 120
          description: 所有權人總數
        chairman_name:
          type: string
          nullable: true
          example: "王大明"
          description: 理事長姓名
        chairman_phone:
          type: string
          nullable: true
          example: "02-12345678"
          description: 理事長電話
        address:
          type: string
          nullable: true
          example: "台北市大安區仁愛路四段 1 號"
          description: 地址
        representative:
          type: string
          nullable: true
          example: "張三"
          description: 代表人
        created_at:
          type: string
          format: date-time
        updated_at:
          type: string
          format: date-time
        deleted_at:
          type: string
          format: date-time
          nullable: true

    UrbanRenewalCreate:
      type: object
      required:
        - name
        - area
        - member_count
      properties:
        name:
          type: string
          maxLength: 255
          example: "台北市大安區都市更新會"
        area:
          type: number
          format: float
          minimum: 0
          example: 5000.50
        member_count:
          type: integer
          minimum: 0
          example: 120
        chairman_name:
          type: string
          maxLength: 100
          example: "王大明"
        chairman_phone:
          type: string
          maxLength: 20
          example: "02-12345678"
        address:
          type: string
          maxLength: 500
          example: "台北市大安區仁愛路四段 1 號"
        representative:
          type: string
          maxLength: 100
          example: "張三"

    UrbanRenewalUpdate:
      type: object
      properties:
        name:
          type: string
          maxLength: 255
        area:
          type: number
          format: float
          minimum: 0
        member_count:
          type: integer
          minimum: 0
        chairman_name:
          type: string
          maxLength: 100
        chairman_phone:
          type: string
          maxLength: 20
        address:
          type: string
          maxLength: 500
        representative:
          type: string
          maxLength: 100

    PropertyOwnerUpdate:
      type: object
      properties:
        full_name:
          type: string
          maxLength: 100
          description: 姓名
        id_number:
          type: string
          maxLength: 20
          description: 身分證號
        phone:
          type: string
          maxLength: 20
          description: 聯絡電話
        mobile:
          type: string
          maxLength: 20
          description: 行動電話
        email:
          type: string
          format: email
          maxLength: 100
          description: Email
        address:
          type: string
          maxLength: 500
          description: 地址
        exclusion_type:
          $ref: './common.yaml#/components/schemas/ExclusionType'

    LandPlotCreate:
      type: object
      required:
        - county_code
        - district_code
        - section_code
        - land_number
        - area
      properties:
        county_code:
          type: string
          maxLength: 10
          example: "A"
          description: 縣市代碼
        district_code:
          type: string
          maxLength: 10
          example: "01"
          description: 鄉鎮市區代碼
        section_code:
          type: string
          maxLength: 10
          example: "0001"
          description: 地段代碼
        land_number:
          type: string
          maxLength: 50
          example: "123"
          description: 地號
        area:
          type: number
          format: float
          minimum: 0
          example: 100.50
          description: 土地面積（平方公尺）

    LandPlotUpdate:
      type: object
      properties:
        county_code:
          type: string
          maxLength: 10
        district_code:
          type: string
          maxLength: 10
        section_code:
          type: string
          maxLength: 10
        land_number:
          type: string
          maxLength: 50
        area:
          type: number
          format: float
          minimum: 0

    County:
      type: object
      properties:
        code:
          type: string
          example: "A"
          description: 縣市代碼
        name:
          type: string
          example: "台北市"
          description: 縣市名稱

    District:
      type: object
      properties:
        code:
          type: string
          example: "01"
          description: 鄉鎮市區代碼
        name:
          type: string
          example: "中正區"
          description: 鄉鎮市區名稱
        county_code:
          type: string
          example: "A"
          description: 所屬縣市代碼

    Section:
      type: object
      properties:
        code:
          type: string
          example: "0001"
          description: 地段代碼
        name:
          type: string
          example: "城中段"
          description: 地段名稱
        district_code:
          type: string
          example: "01"
          description: 所屬鄉鎮市區代碼
