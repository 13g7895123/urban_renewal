# 功能規格：管理員與使用者登入情境

**功能分支**: `002-admin-user`
**建立日期**: 2025-10-24
**狀態**: 草稿
**輸入**: 使用者描述："檢查一下這個專案的登入功能,主要有兩個情境,一個是admin,一個是user,幫我預留這兩個全線即可,未完成的話請幫我完成"

## 澄清事項

### 2025-10-24 會議

- Q: 應該實作何種程度的認證事件追蹤？ → A: 標準 - 追蹤所有認證事件（登入、登出、token 更新、失敗嘗試），並在專用審計資料表或結構化日誌中記錄 IP/user-agent
- Q: 應該如何管理過期的會話？ → A: 定期批次作業 - 自動化排程任務（每日/每週）刪除 expires_at 小於當前時間且 is_active = 0 的會話

## 使用者情境與測試 *(必填)*

### 使用者故事 1 - 管理員登入與系統管理存取權 (優先級：P1)

管理員需要登入系統以管理整個都更平台，包括管理所有都更專案、使用者、系統設定，並對所有資料擁有完整可見性。

**優先級理由**: 管理員存取權是最高優先級，因為它用於配置系統、管理使用者和維護平台。沒有管理功能，系統就無法被正確管理或維護。

**獨立測試**: 可以透過使用管理員憑證（帳號：`admin`，密碼：`password`）登入並驗證對所有管理功能的存取權來完整測試，包括在 `/tables/urban-renewal` 的都更管理儀表板，能夠查看和管理所有專案而不受指派限制。

**驗收情境**:

1. **假設** 管理員在登入頁面，**當** 他們輸入有效的管理員憑證（帳號：`admin`，密碼：`password`），**則** 他們成功登入並被導向到 `/tables/urban-renewal` 且擁有完整系統存取權
2. **假設** 管理員已登入，**當** 他們存取系統的任何部分，**則** 他們可以查看和管理所有資料，不受 urban_renewal_id 指派的限制
3. **假設** 管理員輸入錯誤憑證，**當** 他們嘗試登入，**則** 系統顯示錯誤訊息「帳號或密碼錯誤」並增加登入失敗計數器
4. **假設** 管理員登入失敗 5 次，**當** 他們嘗試第 6 次登入，**則** 他們的帳號被鎖定 30 分鐘，並顯示訊息「帳號已被鎖定,請稍後再試」
5. **假設** 管理員已登入，**當** 他們的會話 token 在 24 小時後過期，**則** 他們可以使用 refresh token 獲得新會話而無需重新輸入憑證

---

### 使用者故事 2 - 一般使用者（會員/理事長）登入與範圍存取 (優先級：P1)

一般使用者（理事長、會員或觀察員）需要登入系統以存取其指派的都更專案、參與會議、查看文件，並根據其角色行使投票權。

**優先級理由**: 一般使用者存取權同樣重要，因為它代表系統的主要使用者，他們需要參與都更活動。這是 P1，因為會員和理事長需要執行核心業務功能，如參加會議和投票。

**獨立測試**: 可以透過使用會員憑證（帳號：`member1`，密碼：`password`）登入並驗證被導向到 `/tables/meeting`，且存取權限制在其指派的 urban_renewal_id 和適當的角色基礎權限內來完整測試。

**驗收情境**:

1. **假設** 會員在登入頁面，**當** 他們輸入有效的會員憑證（帳號：`member1`，密碼：`password`），**則** 他們成功登入並被導向到 `/tables/meeting`
2. **假設** 理事長在登入頁面，**當** 他們輸入有效的理事長憑證（帳號：`chairman`，密碼：`password`），**則** 他們成功登入並被導向到 `/tables/meeting`
3. **假設** 一般使用者已登入，**當** 他們嘗試存取資料，**則** 他們只能查看與其指派的 urban_renewal_id 相關的資料
4. **假設** 會員已登入，**當** 他們存取投票功能，**則** 他們可以為其都更專案投票
5. **假設** 觀察員已登入，**當** 他們存取投票功能，**則** 他們無法投票但可以查看投票資訊
6. **假設** 理事長已登入，**當** 他們存取會議管理，**則** 他們可以為其都更專案建立和管理會議
7. **假設** 會員已登入，**當** 他們存取會議管理，**則** 他們可以查看會議但無法建立或管理會議

---

### 使用者故事 3 - 會話管理與安全性 (優先級：P2)

所有使用者需要安全的會話管理，包括自動 token 更新、安全登出和防止未授權存取，以確保資料安全和持續的使用者體驗。

**優先級理由**: P2，因為雖然安全性很重要，但基本登入/登出功能（P1）必須先運作。會話管理增強使用者體驗和安全性，但補充於核心認證。

**獨立測試**: 可以透過使用任何使用者登入，讓會話接近到期（24 小時），並驗證 refresh token 自動延長會話，或透過登出並確認會話被終止且 tokens 被無效化來測試。

**驗收情境**:

1. **假設** 使用者使用有效的會話 token 登入，**當** token 在 24 小時後過期，**則** 系統自動使用 refresh token 獲得新的會話 token
2. **假設** 使用者點擊登出，**當** 登出請求被處理，**則** 他們的會話在 user_sessions 資料表中被標記為非活動狀態，tokens 從 localStorage 清除，並被導向到 `/auth/login`
3. **假設** 使用者擁有過期的 refresh token（7 天後），**當** 他們嘗試使用系統，**則** 他們被登出且必須重新認證
4. **假設** 攻擊者嘗試重用已無效的會話 token，**當** 他們發出 API 請求，**則** 請求被拒絕並返回 401 Unauthorized
5. **假設** 使用者從受保護頁面存取系統，**當** 他們未被認證，**則** 認證 middleware 將他們導向到 `/auth/login`

---

### 使用者故事 4 - 角色基礎存取控制與路由保護 (優先級：P2)

不同角色的使用者需要適當的存取控制，以便他們只能存取與其權限相關的功能和資料，防止未授權存取敏感的管理資料或其他使用者的資料。

**優先級理由**: P2，因為基本登入必須先運作（P1），但在系統處理真實使用者資料之前，角色基礎限制至關重要。這防止權限提升和未授權存取。

**獨立測試**: 可以透過以不同角色類型（admin、chairman、member、observer）登入並驗證每個角色只能存取其允許的路由和功能，未授權的存取嘗試被導向到 `/unauthorized` 頁面來測試。

**驗收情境**:

1. **假設** 會員嘗試存取僅限管理員的路由 `/tables/urban-renewal`，**當** 路由守衛檢查其角色，**則** 他們被導向到 `/unauthorized` 並顯示訊息「您沒有權限訪問此頁面」
2. **假設** 管理員存取任何路由，**當** 角色 middleware 檢查權限，**則** 存取權被授予而不受限制
3. **假設** 觀察員嘗試存取投票提交端點，**當** 後端驗證權限，**則** 請求被拒絕並返回錯誤「您沒有投票權限」
4. **假設** 理事長嘗試管理使用者，**當** 他們存取使用者管理 API，**則** 請求被拒絕，因為他們缺少 system_admin 權限
5. **假設** 來自 urban_renewal_id=1 的會員嘗試存取 urban_renewal_id=2 的會議資料，**當** 後端驗證資源存取，**則** 請求被拒絕並返回錯誤「無權訪問此資源」

---

### 邊緣案例

- 當使用者的帳號被停用（is_active=0）時，他們有活動會話會發生什麼？系統應該在下次請求時立即使無效其會話並要求重新認證，由於非活動狀態，認證將失敗。
- 當使用者的角色在他們登入時改變會發生什麼？當前會話權限應保持有效直到 token 過期，此時更新將獲得新角色。為了立即執行，管理員應在更改角色時使無效使用者的會話。
- 當使用者在登入時被指派到不同的 urban_renewal_id 會發生什麼？與角色更改類似，當前會話維持舊指派直到 token 更新/重新登入。為了立即執行，使無效會話。
- 如果 JWT_SECRET 金鑰被更改會發生什麼？所有現有 tokens 變為無效，要求所有使用者重新認證。系統應優雅處理並顯示清晰錯誤訊息。
- 當同一使用者發生多個並發登入嘗試會發生什麼？每次成功登入都會使之前的會話無效（當前行為），只有最近的會話保持活動。
- 當鎖定帳號的 login_attempts 計數器需要手動重置會發生什麼？管理員應該能夠手動重置 login_attempts 和 locked_until 欄位，或等待 30 分鐘鎖定期自動到期。
- 如果 refresh token 被洩露會發生什麼？攻擊者可以維持存取長達 7 天。系統應提供「登出所有裝置」功能以使無效所有使用者會話。

## 需求 *(必填)*

### 功能需求

- **FR-001**: 系統必須透過儲存為 bcrypt 雜湊的使用者名稱和密碼憑證來認證使用者
- **FR-002**: 系統必須支援四種不同的使用者角色：admin、chairman、member 和 observer
- **FR-003**: 系統必須在成功登入時生成 24 小時過期的 JWT tokens
- **FR-004**: 系統必須生成 7 天過期的 refresh tokens 用於會話更新
- **FR-005**: 系統必須追蹤登入嘗試並在 5 次連續失敗後鎖定帳號 30 分鐘
- **FR-006**: 系統必須在 user_sessions 資料表中儲存活動會話，包含 token、過期時間、IP 位址和 user agent 資訊
- **FR-007**: 管理員使用者必須對所有都更專案、會議和系統管理功能擁有無限制存取權
- **FR-008**: 非管理員使用者必須將資料存取權限制在其指派的 urban_renewal_id
- **FR-009**: 系統必須在成功登入時將管理員使用者導向到 `/tables/urban-renewal`
- **FR-010**: 系統必須在成功登入時將理事長和會員使用者導向到 `/tables/meeting`
- **FR-011**: 系統必須在使用者使用新憑證登入時使無效所有之前的會話
- **FR-012**: 系統必須允許使用者明確登出，使無效其當前會話
- **FR-013**: 系統必須在所有受保護的 API 端點上驗證會話 token 有效性
- **FR-014**: 系統必須在路由和 API 端點層級強制執行角色基礎存取控制
- **FR-015**: 理事長使用者必須能夠為其指派的都更專案管理會議和投票
- **FR-016**: 會員使用者必須能夠參與其指派的都更專案的投票
- **FR-017**: 觀察員使用者必須擁有唯讀存取權而沒有投票特權
- **FR-018**: 系統必須以繁體中文顯示適當的認證失敗錯誤訊息
- **FR-019**: 系統必須在成功認證時更新 last_login_at 時間戳記並重置 login_attempts 計數器
- **FR-020**: 系統必須提供透過電子郵件 token 的密碼重置功能（目前未完成 - 標記為未來實作）
- **FR-021**: 系統必須透過為每位使用者僅維持最近的活動會話來防止並發會話攻擊
- **FR-022**: 系統必須在會話過期前使用 refresh_token 自動更新 tokens
- **FR-023**: 系統必須從 API 回應的使用者資料中移除敏感欄位（password_hash、password_reset_token、login_attempts）
- **FR-024**: 系統必須記錄所有認證事件（成功登入、失敗登入、登出、token 更新），包含時間戳記、使用者識別碼、IP 位址和 user agent，記錄至專用審計資料表或結構化應用程式日誌
- **FR-025**: 系統必須記錄失敗的認證嘗試，包含嘗試的使用者名稱、IP 位址、時間戳記和失敗原因，用於安全監控
- **FR-026**: 系統必須提供自動化定期清理流程（每日或每週排程），從 user_sessions 資料表中移除過期會話，其中 expires_at 已過當前時間且 is_active 等於 0

### 關鍵實體 *(如果功能涉及資料則包含)*

- **User（使用者）**: 代表系統使用者，具有屬性包括 username、email、password_hash、role（admin/chairman/member/observer）、urban_renewal_id（指派的專案）、property_owner_id（會員用）、full_name、phone、is_active 狀態、登入追蹤（last_login_at、login_attempts、locked_until）和密碼重置 tokens
- **UserSession（使用者會話）**: 代表活動認證會話，具有屬性包括 user_id、session_token（JWT）、refresh_token、過期時間戳記（expires_at、refresh_expires_at）、連線詳情（ip_address、user_agent、device_info）、is_active 狀態和活動追蹤（created_at、last_activity_at）
- **UserPermission（使用者權限）**: 代表細粒度存取控制，具有屬性包括 user_id、permission_type（urban_renewal_manage、meeting_manage、voting_manage、property_owner_manage、system_admin、report_view、document_manage）、resource_id（特定專案/會議）、granted_by（授予權限的管理員）、granted_at 和 expires_at
- **AuthenticationEvent（認證事件）**: 代表認證活動的審計追蹤，具有屬性包括 event_type（login_success、login_failure、logout、token_refresh）、user_id（如果已認證）、username_attempted（失敗嘗試用）、ip_address、user_agent、timestamp、failure_reason（失敗嘗試用）和 event_metadata
- **Urban Renewal Project（都更專案）**: 使用者被指派到的背景實體（透過 urban_renewal_id），決定非管理員使用者的資料可見範圍
- **Role（角色）**: 代表使用者權限層級的邏輯實體 - admin（完整存取）、chairman（專案管理）、member（投票參與）、observer（唯讀）

## 成功標準 *(必填)*

### 可測量成果

- **SC-001**: 管理員使用者可以登入並在從登入起 3 次點擊內存取所有系統管理功能
- **SC-002**: 一般使用者可以登入並在從登入起 2 次點擊內存取其指派的專案會議清單
- **SC-003**: 無效登入嘗試在 1 秒內產生清晰的錯誤回饋
- **SC-004**: 5 次失敗嘗試後的帳號鎖定有效防止暴力攻擊
- **SC-005**: 會話 tokens 在 24 小時內保持有效而無需重新認證
- **SC-006**: Refresh tokens 無縫延長會話而不中斷使用者，最長 7 天
- **SC-007**: 對受限路由的未授權存取嘗試在 500ms 內被阻擋並導向
- **SC-008**: 使用者可以登出並在 2 秒內使無效其會話
- **SC-009**: 角色基礎存取控制防止 100% 的未授權資料存取嘗試（無權限提升）
- **SC-010**: 所有認證操作（登入、登出、token 更新）在正常負載下 2 秒內完成
- **SC-011**: 有效憑證的登入成功率為 99.9%（排除故意鎖定）
- **SC-012**: 零實例的使用者存取其指派的 urban_renewal_id 範圍外的資料（非管理員使用者）

## 假設條件

- 使用者透過支援 localStorage 和標準 HTTP 認證標頭的現代網頁瀏覽器存取系統
- 系統在正式環境中使用 HTTPS 部署以進行安全的 token 傳輸（開發環境在 localhost 使用 HTTP）
- 資料庫連線可靠且查詢效能合理（認證查詢 <100ms）
- 使用者了解其指派的角色，不期望存取超出其權限的功能
- 密碼重置的電子郵件服務整合已規劃但尚未實作
- JWT_SECRET 環境變數已正確配置並保持安全
- 維持系統時鐘同步以進行準確的 token 過期檢查
- IPv4/IPv6 位址可以從 HTTP 請求中可靠地捕獲用於會話追蹤
- 使用者接受來自不同裝置的並發會話將導致只有最近的會話保持活動

## 相依性

- CodeIgniter 4 框架，具有 RESTful 控制器支援
- Firebase JWT 函式庫（firebase/php-jwt）用於 token 生成和驗證
- MariaDB 資料庫用於使用者和會話儲存
- Nuxt 3 框架，具有 Nuxt UI 元件用於前端
- Pinia 狀態管理用於認證 store
- localStorage 瀏覽器 API 用於客戶端 token 持久化
- Users、User Sessions 和 User Permissions 資料表必須存在（遷移已實作）
- Urban Renewals 和 Property Owners 資料表必須存在用於外鍵關係
- API composable（useApi）和 Auth composable（useAuth）必須可用
- Auth middleware 和 role middleware 必須在 Nuxt 路由中配置
- 排程任務執行能力（cron job、任務排程器或等效）用於定期會話清理和維護操作

## 範圍外

- 多因素認證（MFA/2FA）
- 與外部身分提供者的單一登入（SSO）整合
- 社交媒體登入（Google、Facebook 等）
- 生物辨識認證
- 新帳號的電子郵件驗證
- 密碼複雜度要求強制執行（超出最少 6 個字元）
- 帳號註冊/註冊功能（使用者由管理員建立）
- 跨瀏覽器會話的記住我功能
- 超出基本 user agent 追蹤的裝置指紋識別
- 地理限制或 IP 白名單
- 使用者查看/撤銷其活動會話的會話管理儀表板
- 可配置的會話逾時期間（目前硬編碼為 24h/7d）
- 超出基本帳號鎖定的速率限制
- 用於防止自動化攻擊的 CAPTCHA
